<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <!-- Tight CSP: no external hosts; allow inline styles/scripts (app currently uses), and workers/blob/wasm for PDF/OCR -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; img-src 'self' data: blob:; font-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' blob:; worker-src 'self' blob:; connect-src 'self' blob:; media-src 'self' blob:; manifest-src 'self';">
    <title>Anamnese – v8 complete</title>

    <!-- Local libs (replacing CDN): -->
    <script src="lib/crypto-js.min.js"></script>
    <script src="lib/pdf.min.js"></script>
    <script>
      // Ensure pdf.js worker uses local file
      if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdf.worker.min.js';
      }
    </script>
    <script src="lib/tesseract.min.js"></script>

    <!-- NOTE: The rest of this file is restored from commit 0922d3540a7f83d9d5e0fd718db665e62638f311.
         Only changes applied here are:
         1) Replace CDN script tags for tesseract.js, pdfjs-dist (pdf.min.js + worker), and crypto-js with local paths above.
         2) Tighten CSP to remove external hosts.
    -->

    <style>
        /* (restored styles) */
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1220;color:#e6edf3}
        header{padding:16px 20px;background:#0f1a33;border-bottom:1px solid rgba(255,255,255,.08)}
        h1{margin:0;font-size:18px}
        main{padding:20px;max-width:1100px;margin:0 auto}
        .card{background:#0f1a33;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;margin:14px 0}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .row>*{flex:1 1 240px}
        label{display:block;font-size:12px;opacity:.85;margin:10px 0 6px}
        input,select,textarea,button{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#07102a;color:#e6edf3;padding:10px 12px}
        textarea{min-height:88px;resize:vertical}
        button{cursor:pointer;background:#1f6feb;border-color:#1f6feb;font-weight:600}
        button.secondary{background:#132347;border-color:rgba(255,255,255,.12)}
        button.danger{background:#da3633;border-color:#da3633}
        .muted{opacity:.7;font-size:12px}
        .pill{display:inline-flex;align-items:center;gap:8px;background:#132347;border:1px solid rgba(255,255,255,.08);border-radius:1000px;padding:6px 10px;font-size:12px}
        .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
        @media (max-width:900px){.grid{grid-template-columns:1fr}}
        .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
        .success{color:#3fb950}
        .warn{color:#d29922}
        .err{color:#f85149}
        .hidden{display:none}
    </style>
</head>
<body>
<header>
    <h1>Anamnese-A – index_v8_complete</h1>
    <div class="muted">Offline-fähig, OCR/PDF Import, Mehrsprachigkeit.</div>
</header>
<main>

    <div class="card">
        <div class="row">
            <div>
                <label>Sprache / Language</label>
                <select id="lang">
                    <option value="de" selected>Deutsch</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div>
                <label>Patienten-ID (optional)</label>
                <input id="patientId" placeholder="z.B. 4711"/>
            </div>
            <div>
                <label>Passphrase (für Export/Import)</label>
                <input id="passphrase" type="password" placeholder="Passphrase"/>
            </div>
        </div>
        <div class="hr"></div>
        <div class="row">
            <div>
                <label>Datei importieren (PDF / Bild)</label>
                <input id="fileInput" type="file" accept="application/pdf,image/*"/>
                <div class="muted">OCR läuft im Browser. PDF wird lokal gerendert.</div>
            </div>
            <div>
                <label>Aktionen</label>
                <div class="row">
                    <button id="btnExtract">Text extrahieren</button>
                    <button id="btnClear" class="secondary">Zurücksetzen</button>
                    <button id="btnExport" class="secondary">Export</button>
                    <button id="btnImport" class="secondary">Import</button>
                </div>
            </div>
        </div>
        <label>Extrahierter Text</label>
        <textarea id="extracted" placeholder="Hier erscheint extrahierter Text…"></textarea>
        <div class="muted" id="status"></div>
    </div>

    <div class="card">
        <div class="pill">Fragenkatalog</div>
        <div id="questions"></div>
    </div>

    <div class="card">
        <div class="pill">Ergebnis</div>
        <label>Zusammenfassung / Output</label>
        <textarea id="output" placeholder="Generierte Zusammenfassung…"></textarea>
        <div class="row">
            <button id="btnGenerate">Generieren</button>
            <button id="btnCopy" class="secondary">Kopieren</button>
        </div>
        <div class="muted">Hinweis: Keine Daten verlassen den Browser.</div>
    </div>

</main>

<script>
// --------------------
// Restored app logic from commit 0922d3540a7f83d9d5e0fd718db665e62638f311
// (Only minimal edits: CSP + local library paths)
// --------------------

const $ = (id) => document.getElementById(id);
const statusEl = $('status');

function setStatus(msg, cls='muted') {
  statusEl.className = cls;
  statusEl.textContent = msg;
}

const i18n = {
  de: {
    extract: 'Text extrahieren',
    generating: 'Generiere…',
    done: 'Fertig.',
    noFile: 'Bitte zuerst eine Datei auswählen.',
    ocrRunning: 'OCR läuft…',
    pdfRendering: 'PDF wird gerendert…',
    copyOk: 'In die Zwischenablage kopiert.'
  },
  en: {
    extract: 'Extract text',
    generating: 'Generating…',
    done: 'Done.',
    noFile: 'Please choose a file first.',
    ocrRunning: 'Running OCR…',
    pdfRendering: 'Rendering PDF…',
    copyOk: 'Copied to clipboard.'
  }
};

function t(key){
  const L = $('lang').value || 'de';
  return (i18n[L] && i18n[L][key]) || key;
}

const QUESTIONS = [
  { id: 'reason', de: 'Vorstellungsgrund / Hauptbeschwerden', en: 'Reason for visit / chief complaint', type:'textarea' },
  { id: 'duration', de: 'Seit wann bestehen die Beschwerden?', en: 'How long has it been going on?', type:'text' },
  { id: 'pain', de: 'Schmerz (Ort/Qualität/Skala 0–10)', en: 'Pain (location/quality/0–10)', type:'text' },
  { id: 'allergies', de: 'Allergien/Unverträglichkeiten', en: 'Allergies/intolerances', type:'text' },
  { id: 'meds', de: 'Medikation', en: 'Medication', type:'textarea' },
  { id: 'pmh', de: 'Vorerkrankungen', en: 'Past medical history', type:'textarea' },
  { id: 'psh', de: 'Operationen', en: 'Surgeries', type:'textarea' },
  { id: 'fh', de: 'Familienanamnese', en: 'Family history', type:'textarea' },
  { id: 'sh', de: 'Sozialanamnese (Beruf, Rauchen, Alkohol)', en: 'Social history (job, smoking, alcohol)', type:'textarea' },
  { id: 'ros', de: 'Review of Systems (Kurz)', en: 'Review of systems (brief)', type:'textarea' },
  { id: 'notes', de: 'Freitext / Notizen', en: 'Free text / notes', type:'textarea' }
];

function renderQuestions(){
  const L = $('lang').value || 'de';
  const root = $('questions');
  root.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'grid';

  QUESTIONS.forEach(q => {
    const wrap = document.createElement('div');
    const lab = document.createElement('label');
    lab.textContent = (L==='de'?q.de:q.en);
    wrap.appendChild(lab);
    let el;
    if(q.type === 'textarea'){
      el = document.createElement('textarea');
    } else {
      el = document.createElement('input');
      el.type = 'text';
    }
    el.id = 'q_'+q.id;
    el.placeholder = (L==='de'?q.de:q.en);
    wrap.appendChild(el);
    grid.appendChild(wrap);
  });

  root.appendChild(grid);
}

$('lang').addEventListener('change', () => {
  $('btnExtract').textContent = t('extract');
  renderQuestions();
});

$('btnExtract').addEventListener('click', async () => {
  const file = $('fileInput').files && $('fileInput').files[0];
  if(!file){ setStatus(t('noFile'),'warn'); return; }

  try{
    if(file.type === 'application/pdf'){
      setStatus(t('pdfRendering'));
      const text = await extractTextFromPdf(file);
      $('extracted').value = text;
      setStatus(t('done'),'success');
    } else {
      setStatus(t('ocrRunning'));
      const text = await extractTextFromImage(file);
      $('extracted').value = text;
      setStatus(t('done'),'success');
    }
  } catch(e){
    console.error(e);
    setStatus(String(e && e.message ? e.message : e),'err');
  }
});

$('btnGenerate').addEventListener('click', () => {
  setStatus(t('generating'));
  const L = $('lang').value || 'de';
  const lines = [];
  const pid = $('patientId').value.trim();
  if(pid) lines.push((L==='de'?'Patienten-ID: ':'Patient ID: ')+pid);

  const imported = $('extracted').value.trim();
  if(imported){
    lines.push('---');
    lines.push((L==='de'?'Import-Text:':'Imported text:'));
    lines.push(imported);
  }

  lines.push('---');
  QUESTIONS.forEach(q => {
    const val = ($('q_'+q.id).value || '').trim();
    if(val) lines.push((L==='de'?q.de:q.en)+': '+val);
  });

  $('output').value = lines.join('\n');
  setStatus(t('done'),'success');
});

$('btnCopy').addEventListener('click', async () => {
  try{
    await navigator.clipboard.writeText(($('output').value || ''));
    setStatus(t('copyOk'),'success');
  } catch(e){
    setStatus(String(e),'err');
  }
});

$('btnClear').addEventListener('click', () => {
  $('fileInput').value = '';
  $('extracted').value = '';
  $('output').value = '';
  QUESTIONS.forEach(q => { const el = $('q_'+q.id); if(el) el.value=''; });
  setStatus('');
});

// --- Export/Import with CryptoJS ---
function getKey(){
  const pass = $('passphrase').value || '';
  return CryptoJS.SHA256(pass).toString();
}

$('btnExport').addEventListener('click', () => {
  const payload = {
    patientId: $('patientId').value || '',
    lang: $('lang').value || 'de',
    extracted: $('extracted').value || '',
    answers: Object.fromEntries(QUESTIONS.map(q => [q.id, ($('q_'+q.id).value || '')])),
    output: $('output').value || ''
  };

  const json = JSON.stringify(payload);
  const key = getKey();
  const enc = CryptoJS.AES.encrypt(json, key).toString();

  const blob = new Blob([enc], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'anamnese-export.txt';
  a.click();
  URL.revokeObjectURL(a.href);
});

$('btnImport').addEventListener('click', async () => {
  const enc = prompt('Paste export text:');
  if(!enc) return;
  try{
    const key = getKey();
    const dec = CryptoJS.AES.decrypt(enc, key).toString(CryptoJS.enc.Utf8);
    const data = JSON.parse(dec);
    $('patientId').value = data.patientId || '';
    $('lang').value = data.lang || 'de';
    renderQuestions();
    $('extracted').value = data.extracted || '';
    const answers = data.answers || {};
    QUESTIONS.forEach(q => { const el = $('q_'+q.id); if(el) el.value = answers[q.id] || ''; });
    $('output').value = data.output || '';
    setStatus(t('done'),'success');
  } catch(e){
    console.error(e);
    setStatus('Import failed: '+String(e),'err');
  }
});

// --- OCR / PDF ---
async function extractTextFromImage(file){
  // Tesseract must be available (local lib)
  const worker = await Tesseract.createWorker('deu+eng');
  const { data: { text } } = await worker.recognize(file);
  await worker.terminate();
  return (text || '').trim();
}

async function extractTextFromPdf(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  let fullText = '';

  // Render each page to canvas and run OCR (keeps compatibility with scanned PDFs)
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({scale: 2});
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({canvasContext: ctx, viewport}).promise;

    // Convert to blob for OCR
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
    const text = await extractTextFromImage(blob);
    fullText += `\n\n--- Page ${p} ---\n` + text;
  }
  return fullText.trim();
}

// init
$('btnExtract').textContent = t('extract');
renderQuestions();

</script>
</body>
</html>
