<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' https://js.stripe.com https://cdn.jsdelivr.net; img-src 'self' data: https:; connect-src 'self' https://api.stripe.com; frame-src https://js.stripe.com https://hooks.stripe.com;">
    <meta name="stripe-key" content="pk_test_YOUR_PUBLISHABLE_KEY">
    <title>TESTMODUS - Praxis-Code-Generator (Keine Zahlung)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- TEST MODE BANNER -->
    <div style="background: linear-gradient(135deg, #ff9800 0%, #ff6b00 100%); color: white; padding: 15px 0; text-align: center; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1050;">
        <div class="container">
            <i class="bi bi-exclamation-triangle-fill"></i> 
            <span style="font-size: 1.1rem;">TESTMODUS - KEINE ZAHLUNG ERFORDERLICH</span>
            <i class="bi bi-exclamation-triangle-fill"></i>
            <br>
            <small style="opacity: 0.9;">Diese Seite ist nur fÃ¼r Test- und Entwicklungszwecke. Es findet keine echte Zahlung statt.</small>
        </div>
    </div>
    
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/index_nopay.html">
                <i class="bi bi-hospital-fill"></i> Praxis-Code-Generator <span class="badge bg-warning text-dark">TEST</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-9 col-xl-8">
                <!-- Language Selection (Always Visible at Top) -->
                <div class="card mb-4 language-selector-card">
                    <div class="card-body p-3 p-md-4">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-translate"></i> <span class="d-none d-sm-inline">Sprache wÃ¤hlen / Choose Language</span><span class="d-inline d-sm-none">Sprache / Language</span>
                        </h5>
                        <select id="globalLanguageSelect" class="form-select form-select-lg" onchange="updateGlobalLanguage()">
                            <option value="">-- Bitte wÃ¤hlen / Please select --</option>
                            <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                            <option value="de-en">ğŸ‡©ğŸ‡ªğŸ‡¬ğŸ‡§ Deutsch + English</option>
                            <option value="de-ar">ğŸ‡©ğŸ‡ªğŸ‡¸ğŸ‡¦ Deutsch + Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
                            <option value="de-tr">ğŸ‡©ğŸ‡ªğŸ‡¹ğŸ‡· Deutsch + TÃ¼rkÃ§e</option>
                            <option value="de-uk">ğŸ‡©ğŸ‡ªğŸ‡ºğŸ‡¦ Deutsch + Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
                            <option value="de-pl">ğŸ‡©ğŸ‡ªğŸ‡µğŸ‡± Deutsch + Polski</option>
                            <option value="de-fa">ğŸ‡©ğŸ‡ªğŸ‡®ğŸ‡· Deutsch + ÙØ§Ø±Ø³ÛŒ (Farsi)</option>
                            <option value="de-ur">ğŸ‡©ğŸ‡ªğŸ‡µğŸ‡° Deutsch + Ø§Ø±Ø¯Ùˆ (Urdu)</option>
                            <option value="de-ps">ğŸ‡©ğŸ‡ªğŸ‡¦ğŸ‡« Deutsch + Ù¾ÚšØªÙˆ (Pashto)</option>
                            <option value="de-es">ğŸ‡©ğŸ‡ªğŸ‡ªğŸ‡¸ Deutsch + EspaÃ±ol</option>
                            <option value="de-fr">ğŸ‡©ğŸ‡ªğŸ‡«ğŸ‡· Deutsch + FranÃ§ais</option>
                            <option value="de-it">ğŸ‡©ğŸ‡ªğŸ‡®ğŸ‡¹ Deutsch + Italiano</option>
                            <option value="de-ru">ğŸ‡©ğŸ‡ªğŸ‡·ğŸ‡º Deutsch + Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        </select>
                        <div id="languageNotice" class="alert alert-info mt-3 d-none">
                            <i class="bi bi-info-circle"></i> <strong>Sprache ausgewÃ¤hlt!</strong> Der Anamnese-Link wird in dieser Sprache erstellt.
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="progress" style="height: 35px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%;" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <strong><span class="d-none d-sm-inline">Schritt 0 von 7</span><span class="d-inline d-sm-none">0/7</span></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multi-Step Form -->
                <div class="card shadow-lg">
                    <div class="card-body p-3 p-md-4 p-lg-5">
                        <form id="codeGeneratorForm">
                            <!-- Step 0: User Type Selection -->
                            <div id="step0" class="form-step">
                                <h2 class="mb-4 text-center">
                                    <i class="bi bi-person-fill text-primary"></i> Willkommen
                                </h2>
                                <p class="lead text-center mb-5">WÃ¤hlen Sie eine Option:</p>
                                
                                <div class="row g-4">
                                    <!-- Option 1: Practice (Medical Facility) -->
                                    <div class="col-md-6">
                                        <div class="user-type-card" onclick="selectUserType('practice')">
                                            <div class="user-type-icon">
                                                <i class="bi bi-hospital-fill"></i>
                                            </div>
                                            <h3 class="user-type-title">Medizinische Einrichtung</h3>
                                            <p class="user-type-description">
                                                Ich bin eine Praxis/Klinik und mÃ¶chte Codes fÃ¼r meine Patienten erstellen
                                            </p>
                                            <ul class="user-type-features">
                                                <li><i class="bi bi-check-circle-fill"></i> Praxis-ID Login</li>
                                                <li><i class="bi bi-check-circle-fill"></i> Mehrere Codes erstellen</li>
                                                <li><i class="bi bi-check-circle-fill"></i> <strong>0,99 â‚¬</strong> pro Code</li>
                                            </ul>
                                            <button type="button" class="btn btn-primary btn-lg w-100 mt-3">
                                                Als Praxis anmelden <i class="bi bi-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Option 2: Self-Test (Patient pays directly) -->
                                    <div class="col-md-6">
                                        <div class="user-type-card" onclick="selectUserType('selftest')">
                                            <div class="user-type-icon user-type-icon-secondary">
                                                <i class="bi bi-person-check-fill"></i>
                                            </div>
                                            <h3 class="user-type-title">Selbst-Test</h3>
                                            <p class="user-type-description">
                                                Ich mÃ¶chte selbst einen Code kaufen und testen
                                            </p>
                                            <ul class="user-type-features">
                                                <li><i class="bi bi-check-circle-fill"></i> Keine Anmeldung nÃ¶tig</li>
                                                <li><i class="bi bi-check-circle-fill"></i> Sofort testen</li>
                                                <li><i class="bi bi-check-circle-fill"></i> <strong>1,00 â‚¬</strong> einmalig</li>
                                            </ul>
                                            <button type="button" class="btn btn-success btn-lg w-100 mt-3">
                                                Selbst-Test starten <i class="bi bi-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 1: Praxis-ID Login (only for practice users) -->
                            <div id="step1" class="form-step d-none">
                                <h2 class="mb-4">
                                    <i class="bi bi-building text-primary"></i> Praxis-ID Anmeldung
                                </h2>
                                <div class="mb-4">
                                    <label for="practiceId" class="form-label">Praxis-ID (UUID)</label>
                                    <input type="text" class="form-control form-control-lg" id="practiceId" 
                                           placeholder="z.B. 123e4567-e89b-12d3-a456-426614174000">
                                    <div id="practiceIdFeedback" class="invalid-feedback"></div>
                                    <div id="practiceNameDisplay" class="text-success mt-2" style="display: none;">
                                        <i class="bi bi-check-circle-fill"></i> <strong id="practiceName"></strong>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goToStep(0)">
                                        <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                                    </button>
                                    <button type="button" class="btn btn-primary btn-lg flex-grow-1" onclick="validatePracticeId()">
                                        <span id="validateSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        Weiter <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 2: Modus-Auswahl -->
                            <div id="step2" class="form-step d-none">
                                <h2 class="mb-4">
                                    <i class="bi bi-ui-radios text-primary"></i> Eingabemodus wÃ¤hlen
                                </h2>
                                <div class="mb-4">
                                    <div class="form-check mb-3 p-3 border rounded">
                                        <input class="form-check-input" type="radio" name="mode" id="modePractice" value="practice" required>
                                        <label class="form-check-label" for="modePractice">
                                            <strong>Praxis gibt Patientendaten ein</strong><br>
                                            <small class="text-muted">Sie geben die Patientendaten direkt ein</small>
                                        </label>
                                    </div>
                                    <div class="form-check p-3 border rounded">
                                        <input class="form-check-input" type="radio" name="mode" id="modePatient" value="patient" required>
                                        <label class="form-check-label" for="modePatient">
                                            <strong>Patient fÃ¼llt selbst aus</strong><br>
                                            <small class="text-muted">Patient erhÃ¤lt Link zum selbstÃ¤ndigen AusfÃ¼llen</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
                                        <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                                    </button>
                                    <button type="button" class="btn btn-primary flex-grow-1" onclick="goToStep(3)">
                                        Weiter <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Sprach

auswahl -->
                            <div id="step3" class="form-step d-none">
                                <h2 class="mb-4">
                                    <i class="bi bi-translate text-primary"></i> Sprache wÃ¤hlen
                                </h2>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Die gewÃ¤hlte Sprache oben wird fÃ¼r den Anamnese-Link verwendet.
                                </div>
                                <div class="mb-4">
                                    <label for="language" class="form-label">Anamnesebogen-Sprache</label>
                                    <select class="form-select form-select-lg" id="language" required>
                                        <option value="">-- Wird automatisch Ã¼bernommen --</option>
                                        <option value="de">Deutsch</option>
                                        <option value="de-en">Deutsch + Englisch</option>
                                        <option value="de-ar">Deutsch + Arabisch</option>
                                        <option value="de-tr">Deutsch + TÃ¼rkisch</option>
                                        <option value="de-uk">Deutsch + Ukrainisch</option>
                                        <option value="de-pl">Deutsch + Polnisch</option>
                                        <option value="de-fa">Deutsch + Farsi</option>
                                        <option value="de-ur">Deutsch + Urdu</option>
                                        <option value="de-ps">Deutsch + Pashto</option>
                                        <option value="de-es">Deutsch + Spanisch</option>
                                        <option value="de-fr">Deutsch + FranzÃ¶sisch</option>
                                        <option value="de-it">Deutsch + Italienisch</option>
                                        <option value="de-ru">Deutsch + Russisch</option>
                                    </select>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                                        <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                                    </button>
                                    <button type="button" class="btn btn-primary flex-grow-1" onclick="handleStep3Next()">
                                        Weiter <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 4: Patientendaten (nur wenn Modus "practice") -->
                            <div id="step4" class="form-step d-none">
                                <h2 class="mb-4">
                                    <i class="bi bi-person text-primary"></i> Patientendaten eingeben
                                </h2>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">Vorname *</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Nachname *</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="birthDate" class="form-label">Geburtsdatum *</label>
                                    <input type="date" class="form-control" id="birthDate" required>
                                </div>
                                <div class="mb-4">
                                    <label for="address" class="form-label">Adresse (optional)</label>
                                    <textarea class="form-control" id="address" rows="3" 
                                              placeholder="StraÃŸe, PLZ, Stadt"></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goToStep(3)">
                                        <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                                    </button>
                                    <button type="button" class="btn btn-primary flex-grow-1" onclick="goToStep(5)">
                                        Weiter <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 5: Payment -->
                            <div id="step5" class="form-step d-none">
                                <h2 class="mb-4">
                                    <i class="bi bi-credit-card text-primary"></i> Zahlung
                                </h2>
                                <div class="card mb-4 bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title">Zusammenfassung</h5>
                                        <ul class="list-unstyled mb-0">
                                            <li><strong>Praxis:</strong> <span id="summaryPractice"></span></li>
                                            <li><strong>Modus:</strong> <span id="summaryMode"></span></li>
                                            <li><strong>Sprache:</strong> <span id="summaryLanguage"></span></li>
                                            <li id="summaryPatientRow" style="display: none;">
                                                <strong>Patient:</strong> <span id="summaryPatient"></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="alert alert-info" id="paymentInfo">
                                    <i class="bi bi-info-circle"></i> 
                                    <span id="paymentInfoText">Sie werden zu Stripe weitergeleitet, um die Zahlung von <strong>0,99 â‚¬ (inkl. MwSt.)</strong> zu tÃ¤tigen.</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goBackFromStep5()">
                                        <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                                    </button>
                                    <button type="button" class="btn btn-success flex-grow-1" onclick="initiatePayment()">
                                        <span id="paymentSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                        Zur Zahlung <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 6: Code Display (after payment) -->
                            <div id="step6" class="form-step d-none">
                                <div class="text-center">
                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                                    <h2 class="mt-3 mb-4">Zugangscode generiert!</h2>
                                </div>
                                
                                <div class="card mb-4">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">QR-Code scannen</h5>
                                        <div id="qrcodeContainer" class="my-3"></div>
                                        <p class="text-muted">Der Patient kann diesen QR-Code scannen, um zur Anamnese zu gelangen</p>
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">Oder Code kopieren</h5>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" id="codeText" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyCode()">
                                                <i class="bi bi-clipboard"></i> Kopieren
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary" onclick="downloadPDF()">
                                        <i class="bi bi-file-pdf"></i> Als PDF herunterladen
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                                        <i class="bi bi-plus-circle"></i> Neuen Code erstellen
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Hinweis</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Nachricht
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="js/app.js"></script>
    
    <!-- TEST MODE SCRIPT - Force bypass mode awareness -->
    <script>
        // This page is specifically for testing without payment
        // Show a notice on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // Check if bypass is actually enabled
                fetch('/api/bypass-status')
                    .then(res => res.json())
                    .then(data => {
                        if (!data.bypassEnabled) {
                            // Show warning if bypass is not enabled
                            alert('âš ï¸ WARNUNG: Diese Testseite erfordert DEV_BYPASS_PAYMENT=true in der Server-Konfiguration.\n\nBitte setzen Sie in der .env Datei:\nDEV_BYPASS_PAYMENT=true\nNODE_ENV=development\n\nund starten Sie den Server neu.');
                        }
                    })
                    .catch(err => {
                        console.error('Could not check bypass status:', err);
                    });
            }, 1000);
        });
    </script>
</body>
</html>
