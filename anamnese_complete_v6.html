<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Complete Medical History Questionnaire - GDPR Compliant, Offline, Encrypted">
    <meta name="author" content="DiggAi GmbH">
    <title>Medical History Questionnaire v6 - Complete Edition</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'public/lib/pdf.worker.min.js';
        }
    </script>
    
    <style>
        /* =================================================================
           CSS VARIABLES & DESIGN SYSTEM
           ================================================================= */
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --background: #f9fafb;
            --surface: #ffffff;
            --error: #ef4444;
            --warning: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body.dark {
            --primary: #3b82f6;
            --secondary: #34d399;
            --background: #111827;
            --surface: #1f2937;
            --text-dark: #f9fafb;
            --text-light: #d1d5db;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.6;
            transition: all var(--transition);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* =================================================================
           HEADER
           ================================================================= */
        header {
            background: var(--surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 24px;
        }
        
        h1 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }
        
        /* =================================================================
           BUTTONS
           ================================================================= */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        select, input[type="file"] {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-dark);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition);
        }
        
        select:hover, input[type="file"]:hover {
            border-color: var(--primary);
        }
        
        /* =================================================================
           PROGRESS BAR
           ================================================================= */
        .progress-container {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 12px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            border-radius: 6px;
        }
        
        /* =================================================================
           FORM ELEMENTS
           ================================================================= */
        .question-card {
            background: var(--surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 24px;
        }
        
        .question-card h2 {
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        
        .required-star {
            color: var(--error);
            margin-left: 4px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-dark);
            font-size: 16px;
            transition: all var(--transition);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* =================================================================
           MULTISELECT & RADIO OPTIONS
           ================================================================= */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--surface);
        }
        
        .option-item:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .option-item.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .option-item input {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .option-item span {
            flex: 1;
            font-size: 14px;
        }
        
        /* =================================================================
           DATE SELECTS
           ================================================================= */
        .date-select-wrapper {
            display: grid;
            grid-template-columns: 1fr 2fr 1.5fr;
            gap: 12px;
        }
        
        /* =================================================================
           NAVIGATION
           ================================================================= */
        .nav-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .nav-buttons button {
            flex: 1;
        }
        
        /* =================================================================
           SUMMARY BOX
           ================================================================= */
        .summary-box {
            background: var(--surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 24px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .summary-box h3 {
            color: var(--primary);
            margin-bottom: 16px;
        }
        
        .summary-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all var(--transition);
        }
        
        .summary-item:hover {
            background: rgba(37, 99, 235, 0.05);
        }
        
        .summary-label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-light);
        }
        
        .summary-value {
            margin-top: 4px;
            font-size: 15px;
            color: var(--text-dark);
        }
        
        /* =================================================================
           EXPORT AREA
           ================================================================= */
        .export-area {
            background: var(--surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 24px;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        #json-output {
            width: 100%;
            min-height: 150px;
            margin-top: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text-dark);
        }
        
        /* =================================================================
           MODAL
           ================================================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--surface);
            padding: 32px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-content h2 {
            color: var(--primary);
            margin-bottom: 16px;
        }
        
        .modal-content p {
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        /* =================================================================
           ALERTS
           ================================================================= */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid var(--warning);
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid var(--secondary);
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid var(--error);
        }
        
        /* =================================================================
           UTILITIES
           ================================================================= */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-4 {
            margin-top: 24px;
        }
        
        /* =================================================================
           RTL SUPPORT (ARABIC)
           ================================================================= */
        body[dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        
        body[dir="rtl"] .option-item input {
            margin-right: 0;
            margin-left: 12px;
        }
        
        body[dir="rtl"] .btn {
            flex-direction: row-reverse;
        }
        
        /* =================================================================
           RESPONSIVE DESIGN
           ================================================================= */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            header {
                padding: 16px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .header-controls {
                flex-direction: column;
            }
            
            .date-select-wrapper {
                grid-template-columns: 1fr;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 375px) {
            body {
                font-size: 14px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Privacy Modal -->
    <div id="privacy-modal" class="modal active">
        <div class="modal-content">
            <h2>üîí <span data-i18n="privacy_title">Privacy Notice</span></h2>
            <p data-i18n="privacy_text">
                This application processes your health data exclusively locally on your device. 
                No data is transmitted to external servers. All data is encrypted before export.
                By clicking 'Accept & Start' you agree to local processing.
            </p>
            <button class="btn btn-primary" onclick="App.acceptPrivacy()">
                ‚úì <span data-i18n="accept_start">Accept & Start</span>
            </button>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <!-- Header -->
        <header>
            <h1>üè• <span data-i18n="app_title">Medical History Questionnaire</span></h1>
            
            <div class="alert alert-warning" data-i18n="disclaimer_medical">
                This is a digital medical history tool and does not replace a medical examination.
            </div>
            
            <div class="alert alert-success" data-i18n="disclaimer_privacy">
                Your data is stored locally and encrypted. GDPR compliant.
            </div>
            
            <div class="header-controls">
                <select id="language-select" onchange="App.changeLanguage(this.value)">
                    <option value="en">üá¨üáß English</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="it">üáÆüáπ Italiano</option>
                    <option value="pt">üáµüáπ Portugu√™s</option>
                    <option value="nl">üá≥üá± Nederlands</option>
                    <option value="pl">üáµüá± Polski</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="tr">üáπüá∑ T√ºrk√ße</option>
                    <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                </select>
                
                <button class="btn btn-secondary" onclick="App.toggleTheme()">
                    <span id="theme-icon">üåô</span>
                    <span data-i18n="dark_mode">Dark Mode</span>
                </button>
                
                <button class="btn btn-secondary" onclick="App.saveProgress()">
                    üíæ <span data-i18n="save">Save</span>
                </button>
                
                <button class="btn btn-secondary" onclick="document.getElementById('load-file').click()">
                    üìÇ <span data-i18n="load">Load</span>
                </button>
                <input type="file" id="load-file" accept=".json,.txt" style="display:none" onchange="App.loadProgress(event)">
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-text" id="progress-text">
                <span data-i18n="section">Section</span> <span id="progress-current">1</span> <span data-i18n="of">of</span> <span id="progress-total">7</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 14%"></div>
            </div>
        </div>

        <!-- Summary Box (Initially Hidden) -->
        <div id="summary-box" class="summary-box hidden">
            <h3><span data-i18n="summary_title">üìã Summary of Your Answers</span></h3>
            <div id="summary-content"></div>
        </div>

        <!-- Question Area -->
        <div class="question-card" id="question-area">
            <!-- Questions will be rendered here -->
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <button class="btn btn-secondary" id="prev-btn" onclick="App.prevSection()" disabled>
                ‚Üê <span data-i18n="previous">Previous</span>
            </button>
            <button class="btn btn-primary" id="next-btn" onclick="App.nextSection()">
                <span data-i18n="next">Next</span> ‚Üí
            </button>
            <button class="btn btn-primary hidden" id="finish-btn" onclick="App.finish()">
                ‚úì <span data-i18n="finish">Finish</span>
            </button>
        </div>

        <!-- Export Area (shown at end) -->
        <div id="export-area" class="export-area hidden">
            <h3><span data-i18n="export_title">üì§ Export Your Data</span></h3>
            
            <div class="export-buttons">
                <button class="btn btn-primary" onclick="App.exportEncrypted()">
                    üîí <span data-i18n="export_encrypted">Download Encrypted (.txt)</span>
                </button>
                <button class="btn btn-secondary" onclick="App.exportPlain()">
                    üìÑ <span data-i18n="export_plain">Download Plain (.json)</span>
                </button>
                <button class="btn btn-secondary" onclick="App.sendEmail()">
                    ‚úâÔ∏è <span data-i18n="send_email">Send via Email</span>
                </button>
                <button class="btn btn-secondary" onclick="App.exportNFC()">
                    üì± <span data-i18n="export_nfc">NFC Export</span>
                </button>
            </div>
            
            <div class="mt-4">
                <label><span data-i18n="encrypted_output">Encrypted Output (for healthcare providers):</span></label>
                <textarea id="json-output" readonly></textarea>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-secondary" onclick="App.showDecryptModal()">
                    üîì <span data-i18n="decrypt_data">Decrypt Data (Healthcare Provider)</span>
                </button>
            </div>
            
            <div class="mt-4">
                <button class="btn btn-secondary" onclick="document.getElementById('doc-upload').click()">
                    üìé <span data-i18n="upload_docs">Upload Documents (OCR/PDF)</span>
                </button>
                <input type="file" id="doc-upload" accept="image/*,.pdf,.txt" multiple style="display:none" onchange="App.processDocuments(event)">
            </div>
        </div>
    </div>

    <!-- Decrypt Modal -->
    <div id="decrypt-modal" class="modal">
        <div class="modal-content">
            <h2>üîì <span data-i18n="decrypt_title">Decrypt Patient Data</span></h2>
            <p data-i18n="decrypt_instructions">
                Paste the encrypted data below to decrypt:
            </p>
            <textarea id="decrypt-input" style="width: 100%; min-height: 150px; margin-bottom: 16px;"></textarea>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="App.decrypt()">
                    üîì <span data-i18n="decrypt_btn">Decrypt</span>
                </button>
                <button class="btn btn-secondary" onclick="App.closeDecryptModal()">
                    <span data-i18n="cancel">Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <script>
// =================================================================
// TRANSLATIONS (12 LANGUAGES)
// =================================================================
const TRANSLATIONS = {
    en: {
        // App
        app_title: "Medical History Questionnaire",
        privacy_title: "Privacy Notice",
        privacy_text: "This application processes your health data exclusively locally on your device. No data is transmitted to external servers. All data is encrypted before export. By clicking 'Accept & Start' you agree to local processing.",
        accept_start: "Accept & Start",
        disclaimer_medical: "This is a digital medical history tool and does not replace a medical examination.",
        disclaimer_privacy: "Your data is stored locally and encrypted. GDPR compliant.",
        
        // Navigation
        previous: "Previous",
        next: "Next",
        finish: "Finish",
        save: "Save",
        load: "Load",
        section: "Section",
        of: "of",
        
        // Sections
        section_personal: "Personal Information",
        section_medical: "Medical History",
        section_symptoms: "Current Symptoms",
        section_family: "Family History",
        section_lifestyle: "Lifestyle",
        section_medications: "Medications",
        section_consent: "Consent & Contact",
        
        // Questions - Personal Info
        first_name: "First Name",
        last_name: "Last Name",
        date_of_birth: "Date of Birth",
        day: "Day",
        month: "Month",
        year: "Year",
        gender: "Gender",
        gender_male: "Male",
        gender_female: "Female",
        gender_other: "Other",
        address: "Address",
        phone: "Phone Number",
        email: "Email Address",
        
        // Medical History
        chronic_diseases: "Do you have any chronic diseases?",
        chronic_diabetes: "Diabetes",
        chronic_hypertension: "Hypertension (High Blood Pressure)",
        chronic_asthma: "Asthma",
        chronic_copd: "COPD (Chronic Obstructive Pulmonary Disease)",
        chronic_heart: "Heart Disease",
        chronic_cancer: "Cancer",
        chronic_kidney: "Kidney Disease",
        chronic_liver: "Liver Disease",
        chronic_thyroid: "Thyroid Disease",
        
        previous_surgeries: "Previous Surgeries (please describe)",
        known_allergies: "Known Allergies",
        allergy_penicillin: "Penicillin",
        allergy_aspirin: "Aspirin",
        allergy_ibuprofen: "Ibuprofen",
        allergy_latex: "Latex",
        allergy_pollen: "Pollen",
        allergy_dust: "Dust",
        allergy_food: "Food Allergies",
        
        current_medications: "Current Medications (please list)",
        
        // Lifestyle
        smoking_status: "Smoking Status",
        smoking_never: "Never Smoked",
        smoking_former: "Former Smoker",
        smoking_current: "Current Smoker",
        years_smoking: "How many years have you been smoking?",
        
        alcohol_consumption: "Alcohol Consumption",
        alcohol_never: "Never",
        alcohol_occasionally: "Occasionally",
        alcohol_regularly: "Regularly",
        
        exercise_level: "Exercise Level",
        exercise_none: "None",
        exercise_light: "Light (1-2 times/week)",
        exercise_moderate: "Moderate (3-4 times/week)",
        exercise_intense: "Intense (5+ times/week)",
        
        // Current Symptoms
        main_complaint: "Main Complaint / Reason for Visit",
        symptom_duration: "How long have you had these symptoms?",
        duration_24h: "Less than 24 hours",
        duration_week: "1-7 days",
        duration_month: "1-4 weeks",
        duration_long: "More than 4 weeks",
        
        pain_level: "Pain Level (0-10)",
        pain_none: "0 - No pain",
        pain_severe: "10 - Worst imaginable",
        
        additional_symptoms: "Additional Symptoms",
        symptom_fever: "Fever",
        symptom_cough: "Cough",
        symptom_breath: "Shortness of Breath",
        symptom_nausea: "Nausea/Vomiting",
        symptom_dizziness: "Dizziness",
        symptom_fatigue: "Fatigue",
        symptom_headache: "Headache",
        
        // Family History
        family_diseases: "Family Medical History",
        family_diabetes: "Diabetes",
        family_heart: "Heart Disease",
        family_cancer: "Cancer",
        family_mental: "Mental Illness",
        family_autoimmune: "Autoimmune Diseases",
        family_details: "Family History Details (please describe)",
        
        // Consent
        data_consent: "I consent to the processing of my health data for medical purposes",
        privacy_acceptance: "I have read and accept the privacy policy",
        consent_yes: "Yes, I consent",
        consent_no: "No",
        consent_accepted: "Accepted",
        consent_declined: "Declined",
        
        // Export
        export_title: "Export Your Data",
        export_encrypted: "Download Encrypted (.txt)",
        export_plain: "Download Plain (.json)",
        send_email: "Send via Email",
        export_nfc: "NFC Export",
        encrypted_output: "Encrypted Output (for healthcare providers)",
        decrypt_data: "Decrypt Data (Healthcare Provider)",
        upload_docs: "Upload Documents (OCR/PDF)",
        
        // Decryption
        decrypt_title: "Decrypt Patient Data",
        decrypt_instructions: "Paste the encrypted data below to decrypt:",
        decrypt_btn: "Decrypt",
        cancel: "Cancel",
        
        // Messages
        summary_title: "Summary of Your Answers",
        required_fields: "Please fill in all required fields",
        data_saved: "Data saved successfully",
        data_loaded: "Data loaded successfully",
        encryption_password_prompt: "This data is encrypted. The decryption key is securely stored.",
        email_subject: "Medical History Questionnaire",
        email_body: "Please find my encrypted medical history attached below:",
        nfc_success: "Data written to NFC successfully",
        nfc_error: "NFC write failed: ",
        nfc_simulation: "NFC API not available. This is a simulation. The encrypted data is displayed in the output box.",
        dark_mode: "Dark Mode",
        light_mode: "Light Mode",
        please_select: "Please select...",
        
        // Validation
        invalid_email: "Please enter a valid email address",
        invalid_phone: "Please enter a valid phone number",
    },
    
    de: {
        // App
        app_title: "Medizinische Anamnese",
        privacy_title: "Datenschutzhinweis",
        privacy_text: "Diese Anwendung verarbeitet Ihre Gesundheitsdaten ausschlie√ülich lokal auf Ihrem Ger√§t. Es werden keine Daten an externe Server √ºbertragen. Alle Daten werden vor dem Export verschl√ºsselt. Durch Klicken auf 'Akzeptieren & Starten' stimmen Sie der lokalen Verarbeitung zu.",
        accept_start: "Akzeptieren & Starten",
        disclaimer_medical: "Dies ist ein digitales Anamnesetool und ersetzt keine √§rztliche Untersuchung.",
        disclaimer_privacy: "Ihre Daten werden lokal gespeichert und verschl√ºsselt. DSGVO-konform.",
        
        // Navigation
        previous: "Zur√ºck",
        next: "Weiter",
        finish: "Abschlie√üen",
        save: "Speichern",
        load: "Laden",
        section: "Abschnitt",
        of: "von",
        
        // Sections
        section_personal: "Pers√∂nliche Informationen",
        section_medical: "Krankengeschichte",
        section_symptoms: "Aktuelle Symptome",
        section_family: "Familienanamnese",
        section_lifestyle: "Lebensstil",
        section_medications: "Medikamente",
        section_consent: "Einwilligung & Kontakt",
        
        // Questions - Personal Info
        first_name: "Vorname",
        last_name: "Nachname",
        date_of_birth: "Geburtsdatum",
        day: "Tag",
        month: "Monat",
        year: "Jahr",
        gender: "Geschlecht",
        gender_male: "M√§nnlich",
        gender_female: "Weiblich",
        gender_other: "Andere",
        address: "Adresse",
        phone: "Telefonnummer",
        email: "E-Mail-Adresse",
        
        // Medical History
        chronic_diseases: "Haben Sie chronische Erkrankungen?",
        chronic_diabetes: "Diabetes",
        chronic_hypertension: "Bluthochdruck",
        chronic_asthma: "Asthma",
        chronic_copd: "COPD (Chronisch obstruktive Lungenerkrankung)",
        chronic_heart: "Herzerkrankung",
        chronic_cancer: "Krebs",
        chronic_kidney: "Nierenerkrankung",
        chronic_liver: "Lebererkrankung",
        chronic_thyroid: "Schilddr√ºsenerkrankung",
        
        previous_surgeries: "Fr√ºhere Operationen (bitte beschreiben)",
        known_allergies: "Bekannte Allergien",
        allergy_penicillin: "Penicillin",
        allergy_aspirin: "Aspirin",
        allergy_ibuprofen: "Ibuprofen",
        allergy_latex: "Latex",
        allergy_pollen: "Pollen",
        allergy_dust: "Staub",
        allergy_food: "Nahrungsmittelallergien",
        
        current_medications: "Aktuelle Medikamente (bitte auflisten)",
        
        // Lifestyle
        smoking_status: "Raucherstatus",
        smoking_never: "Nie geraucht",
        smoking_former: "Ex-Raucher",
        smoking_current: "Aktueller Raucher",
        years_smoking: "Wie viele Jahre rauchen Sie schon?",
        
        alcohol_consumption: "Alkoholkonsum",
        alcohol_never: "Nie",
        alcohol_occasionally: "Gelegentlich",
        alcohol_regularly: "Regelm√§√üig",
        
        exercise_level: "Bewegungsniveau",
        exercise_none: "Keine",
        exercise_light: "Leicht (1-2 mal/Woche)",
        exercise_moderate: "M√§√üig (3-4 mal/Woche)",
        exercise_intense: "Intensiv (5+ mal/Woche)",
        
        // Current Symptoms
        main_complaint: "Hauptbeschwerde / Grund f√ºr den Besuch",
        symptom_duration: "Wie lange haben Sie diese Symptome?",
        duration_24h: "Weniger als 24 Stunden",
        duration_week: "1-7 Tage",
        duration_month: "1-4 Wochen",
        duration_long: "Mehr als 4 Wochen",
        
        pain_level: "Schmerzst√§rke (0-10)",
        pain_none: "0 - Kein Schmerz",
        pain_severe: "10 - St√§rkster vorstellbarer Schmerz",
        
        additional_symptoms: "Zus√§tzliche Symptome",
        symptom_fever: "Fieber",
        symptom_cough: "Husten",
        symptom_breath: "Kurzatmigkeit",
        symptom_nausea: "√úbelkeit/Erbrechen",
        symptom_dizziness: "Schwindel",
        symptom_fatigue: "M√ºdigkeit",
        symptom_headache: "Kopfschmerzen",
        
        // Family History
        family_diseases: "Familienanamnese",
        family_diabetes: "Diabetes",
        family_heart: "Herzerkrankung",
        family_cancer: "Krebs",
        family_mental: "Psychische Erkrankung",
        family_autoimmune: "Autoimmunerkrankungen",
        family_details: "Details zur Familiengeschichte (bitte beschreiben)",
        
        // Consent
        data_consent: "Ich willige in die Verarbeitung meiner Gesundheitsdaten f√ºr medizinische Zwecke ein",
        privacy_acceptance: "Ich habe die Datenschutzerkl√§rung gelesen und akzeptiere sie",
        consent_yes: "Ja, ich willige ein",
        consent_no: "Nein",
        consent_accepted: "Akzeptiert",
        consent_declined: "Abgelehnt",
        
        // Export
        export_title: "Daten exportieren",
        export_encrypted: "Verschl√ºsselt herunterladen (.txt)",
        export_plain: "Unverschl√ºsselt herunterladen (.json)",
        send_email: "Per E-Mail senden",
        export_nfc: "NFC-Export",
        encrypted_output: "Verschl√ºsselte Ausgabe (f√ºr Gesundheitsdienstleister)",
        decrypt_data: "Daten entschl√ºsseln (Gesundheitsdienstleister)",
        upload_docs: "Dokumente hochladen (OCR/PDF)",
        
        // Decryption
        decrypt_title: "Patientendaten entschl√ºsseln",
        decrypt_instructions: "F√ºgen Sie die verschl√ºsselten Daten unten ein:",
        decrypt_btn: "Entschl√ºsseln",
        cancel: "Abbrechen",
        
        // Messages
        summary_title: "Zusammenfassung Ihrer Antworten",
        required_fields: "Bitte f√ºllen Sie alle Pflichtfelder aus",
        data_saved: "Daten erfolgreich gespeichert",
        data_loaded: "Daten erfolgreich geladen",
        encryption_password_prompt: "Diese Daten sind verschl√ºsselt. Der Entschl√ºsselungsschl√ºssel wird sicher gespeichert.",
        email_subject: "Medizinische Anamnese",
        email_body: "Bitte finden Sie meine verschl√ºsselte Krankengeschichte unten:",
        nfc_success: "Daten erfolgreich auf NFC geschrieben",
        nfc_error: "NFC-Schreibvorgang fehlgeschlagen: ",
        nfc_simulation: "NFC-API nicht verf√ºgbar. Dies ist eine Simulation. Die verschl√ºsselten Daten werden im Ausgabefeld angezeigt.",
        dark_mode: "Dunkelmodus",
        light_mode: "Hellmodus",
        please_select: "Bitte ausw√§hlen...",
        
        // Validation
        invalid_email: "Bitte geben Sie eine g√ºltige E-Mail-Adresse ein",
        invalid_phone: "Bitte geben Sie eine g√ºltige Telefonnummer ein",
    },
    
    // Abbreviated translations for other languages (fr, es, it, pt, nl, pl, ru, tr, ar, zh)
    // For brevity, I'll add key translations for each
    
    fr: {
        app_title: "Questionnaire d'Ant√©c√©dents M√©dicaux",
        accept_start: "Accepter et Commencer",
        previous: "Pr√©c√©dent",
        next: "Suivant",
        finish: "Terminer",
        section_personal: "Informations Personnelles",
        section_medical: "Ant√©c√©dents M√©dicaux",
        section_symptoms: "Sympt√¥mes Actuels",
        section_family: "Ant√©c√©dents Familiaux",
        first_name: "Pr√©nom",
        last_name: "Nom",
        gender: "Sexe",
        chronic_diseases: "Avez-vous des maladies chroniques?",
        smoking_status: "Statut tabagique",
        main_complaint: "Plainte principale",
        data_consent: "Je consens au traitement de mes donn√©es de sant√©",
        export_encrypted: "T√©l√©charger crypt√© (.txt)",
    },
    
    es: {
        app_title: "Cuestionario de Historia M√©dica",
        accept_start: "Aceptar e Iniciar",
        previous: "Anterior",
        next: "Siguiente",
        finish: "Finalizar",
        section_personal: "Informaci√≥n Personal",
        section_medical: "Historia M√©dica",
        section_symptoms: "S√≠ntomas Actuales",
        section_family: "Historia Familiar",
        first_name: "Nombre",
        last_name: "Apellido",
        gender: "G√©nero",
        chronic_diseases: "¬øTiene enfermedades cr√≥nicas?",
        smoking_status: "Estado de fumador",
        main_complaint: "Queja principal",
        data_consent: "Consiento el procesamiento de mis datos de salud",
        export_encrypted: "Descargar encriptado (.txt)",
    },
    
    it: {
        app_title: "Questionario Anamnesi Medica",
        accept_start: "Accetta e Inizia",
        previous: "Precedente",
        next: "Successivo",
        finish: "Termina",
        section_personal: "Informazioni Personali",
        section_medical: "Storia Medica",
        section_symptoms: "Sintomi Attuali",
        section_family: "Storia Familiare",
        first_name: "Nome",
        last_name: "Cognome",
        gender: "Genere",
        chronic_diseases: "Ha malattie croniche?",
        smoking_status: "Stato di fumatore",
        main_complaint: "Reclamo principale",
        data_consent: "Acconsento al trattamento dei miei dati sanitari",
        export_encrypted: "Scarica crittografato (.txt)",
    },
    
    pt: {
        app_title: "Question√°rio de Hist√≥rico M√©dico",
        accept_start: "Aceitar e Iniciar",
        previous: "Anterior",
        next: "Pr√≥ximo",
        finish: "Concluir",
        section_personal: "Informa√ß√µes Pessoais",
        section_medical: "Hist√≥rico M√©dico",
        section_symptoms: "Sintomas Atuais",
        section_family: "Hist√≥rico Familiar",
        first_name: "Nome",
        last_name: "Sobrenome",
        gender: "G√™nero",
        chronic_diseases: "Voc√™ tem doen√ßas cr√¥nicas?",
        smoking_status: "Status de fumante",
        main_complaint: "Queixa principal",
        data_consent: "Consinto o processamento dos meus dados de sa√∫de",
        export_encrypted: "Baixar criptografado (.txt)",
    },
    
    nl: {
        app_title: "Medische Geschiedenis Vragenlijst",
        accept_start: "Accepteren en Starten",
        previous: "Vorige",
        next: "Volgende",
        finish: "Voltooien",
        section_personal: "Persoonlijke Informatie",
        section_medical: "Medische Geschiedenis",
        section_symptoms: "Huidige Symptomen",
        section_family: "Familie Geschiedenis",
        first_name: "Voornaam",
        last_name: "Achternaam",
        gender: "Geslacht",
        chronic_diseases: "Heeft u chronische ziekten?",
        smoking_status: "Rook status",
        main_complaint: "Hoofdklacht",
        data_consent: "Ik stem in met de verwerking van mijn gezondheidsgegevens",
        export_encrypted: "Download versleuteld (.txt)",
    },
    
    pl: {
        app_title: "Kwestionariusz Wywiadu Medycznego",
        accept_start: "Zaakceptuj i Rozpocznij",
        previous: "Poprzedni",
        next: "Nastƒôpny",
        finish: "Zako≈Ñcz",
        section_personal: "Informacje Osobiste",
        section_medical: "Historia Medyczna",
        section_symptoms: "Obecne Objawy",
        section_family: "Historia Rodzinna",
        first_name: "Imiƒô",
        last_name: "Nazwisko",
        gender: "P≈Çeƒá",
        chronic_diseases: "Czy masz choroby przewlek≈Çe?",
        smoking_status: "Status palenia",
        main_complaint: "G≈Ç√≥wna skarga",
        data_consent: "Wyra≈ºam zgodƒô na przetwarzanie moich danych zdrowotnych",
        export_encrypted: "Pobierz zaszyfrowane (.txt)",
    },
    
    ru: {
        app_title: "–ê–Ω–∫–µ—Ç–∞ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –ò—Å—Ç–æ—Ä–∏–∏",
        accept_start: "–ü—Ä–∏–Ω—è—Ç—å –∏ –ù–∞—á–∞—Ç—å",
        previous: "–ù–∞–∑–∞–¥",
        next: "–î–∞–ª–µ–µ",
        finish: "–ó–∞–≤–µ—Ä—à–∏—Ç—å",
        section_personal: "–õ–∏—á–Ω–∞—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
        section_medical: "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ò—Å—Ç–æ—Ä–∏—è",
        section_symptoms: "–¢–µ–∫—É—â–∏–µ –°–∏–º–ø—Ç–æ–º—ã",
        section_family: "–°–µ–º–µ–π–Ω–∞—è –ò—Å—Ç–æ—Ä–∏—è",
        first_name: "–ò–º—è",
        last_name: "–§–∞–º–∏–ª–∏—è",
        gender: "–ü–æ–ª",
        chronic_diseases: "–£ –≤–∞—Å –µ—Å—Ç—å —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è?",
        smoking_status: "–°—Ç–∞—Ç—É—Å –∫—É—Ä–µ–Ω–∏—è",
        main_complaint: "–û—Å–Ω–æ–≤–Ω–∞—è –∂–∞–ª–æ–±–∞",
        data_consent: "–Ø –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö –æ –∑–¥–æ—Ä–æ–≤—å–µ",
        export_encrypted: "–°–∫–∞—á–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π (.txt)",
    },
    
    tr: {
        app_title: "Tƒ±bbi Ge√ßmi≈ü Anketi",
        accept_start: "Kabul Et ve Ba≈üla",
        previous: "√ñnceki",
        next: "Sonraki",
        finish: "Bitir",
        section_personal: "Ki≈üisel Bilgiler",
        section_medical: "Tƒ±bbi Ge√ßmi≈ü",
        section_symptoms: "Mevcut Belirtiler",
        section_family: "Aile Ge√ßmi≈üi",
        first_name: "Ad",
        last_name: "Soyad",
        gender: "Cinsiyet",
        chronic_diseases: "Kronik hastalƒ±klarƒ±nƒ±z var mƒ±?",
        smoking_status: "Sigara i√ßme durumu",
        main_complaint: "Ana ≈üikayet",
        data_consent: "Saƒülƒ±k verilerimin i≈ülenmesine izin veriyorum",
        export_encrypted: "≈ûifreli indir (.txt)",
    },
    
    ar: {
        app_title: "ÿßÿ≥ÿ™ÿ®ŸäÿßŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®Ÿä",
        accept_start: "ŸÇÿ®ŸàŸÑ ŸàÿßŸÑÿ®ÿØÿ°",
        previous: "ÿßŸÑÿ≥ÿßÿ®ŸÇ",
        next: "ÿßŸÑÿ™ÿßŸÑŸä",
        finish: "ÿ•ŸÜŸáÿßÿ°",
        section_personal: "ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
        section_medical: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ÿ®Ÿä",
        section_symptoms: "ÿßŸÑÿ£ÿπÿ±ÿßÿ∂ ÿßŸÑÿ≠ÿßŸÑŸäÿ©",
        section_family: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿπÿßÿ¶ŸÑŸä",
        first_name: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ",
        last_name: "ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ©",
        gender: "ÿßŸÑÿ¨ŸÜÿ≥",
        chronic_diseases: "ŸáŸÑ ŸÑÿØŸäŸÉ ÿ£ŸÖÿ±ÿßÿ∂ ŸÖÿ≤ŸÖŸÜÿ©ÿü",
        smoking_status: "ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿØÿÆŸäŸÜ",
        main_complaint: "ÿßŸÑÿ¥ŸÉŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
        data_consent: "ÿ£ŸàÿßŸÅŸÇ ÿπŸÑŸâ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ŸäÿßŸÜÿßÿ™Ÿä ÿßŸÑÿµÿ≠Ÿäÿ©",
        export_encrypted: "ÿ™ŸÜÿ≤ŸäŸÑ ŸÖÿ¥ŸÅÿ± (.txt)",
    },
    
    zh: {
        app_title: "ÁóÖÂè≤ÈóÆÂç∑",
        accept_start: "Êé•ÂèóÂπ∂ÂºÄÂßã",
        previous: "‰∏ä‰∏Ä‰∏™",
        next: "‰∏ã‰∏Ä‰∏™",
        finish: "ÂÆåÊàê",
        section_personal: "‰∏™‰∫∫‰ø°ÊÅØ",
        section_medical: "ÁóÖÂè≤",
        section_symptoms: "ÂΩìÂâçÁóáÁä∂",
        section_family: "ÂÆ∂ÊóèÂè≤",
        first_name: "ÂêçÂ≠ó",
        last_name: "ÂßìÊ∞è",
        gender: "ÊÄßÂà´",
        chronic_diseases: "ÊÇ®ÊòØÂê¶ÊúâÊÖ¢ÊÄßÁóÖÔºü",
        smoking_status: "Âê∏ÁÉüÁä∂ÂÜµ",
        main_complaint: "‰∏ªË¶ÅÊäïËØâ",
        data_consent: "ÊàëÂêåÊÑèÂ§ÑÁêÜÊàëÁöÑÂÅ•Â∫∑Êï∞ÊçÆ",
        export_encrypted: "‰∏ãËΩΩÂä†ÂØÜÊñá‰ª∂ (.txt)",
    }
};

// =================================================================
// ENCRYPTION (AES-256-GCM with PBKDF2)
// =================================================================
const ENCRYPTION_KEY = "DiggAi-Medical-Anamnese-Key-v6"; // 32 bytes required

async function deriveKey(password, salt) {
    const encoder = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        encoder.encode(password),
        'PBKDF2',
        false,
        ['deriveBits', 'deriveKey']
    );
    
    return crypto.subtle.deriveKey(
        {
            name: 'PBKDF2',
            salt: salt,
            iterations: 100000,
            hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
    );
}

async function encryptData(data) {
    try {
        const encoder = new TextEncoder();
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        
        const key = await deriveKey(ENCRYPTION_KEY, salt);
        
        const encrypted = await crypto.subtle.encrypt(
            { name: 'AES-GCM', iv: iv },
            key,
            encoder.encode(data)
        );
        
        // Combine salt + iv + encrypted data
        const result = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
        result.set(salt, 0);
        result.set(iv, salt.length);
        result.set(new Uint8Array(encrypted), salt.length + iv.length);
        
        // Convert to base64
        return btoa(String.fromCharCode(...result));
    } catch (e) {
        console.error('Encryption error:', e);
        throw e;
    }
}

async function decryptData(encryptedBase64) {
    try {
        const decoder = new TextDecoder();
        const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
        
        const salt = encrypted.slice(0, 16);
        const iv = encrypted.slice(16, 28);
        const data = encrypted.slice(28);
        
        const key = await deriveKey(ENCRYPTION_KEY, salt);
        
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv },
            key,
            data
        );
        
        return decoder.decode(decrypted);
    } catch (e) {
        console.error('Decryption error:', e);
        throw e;
    }
}

// =================================================================
// QUESTION DATA STRUCTURE
// =================================================================
const QUESTION_DATA = {
    sections: [
        {
            id: 'personal',
            questions: [
                { id: 'first_name', type: 'text', required: true },
                { id: 'last_name', type: 'text', required: true },
                { id: 'day', type: 'select', required: true, options: Array.from({length: 31}, (_, i) => i + 1) },
                { id: 'month', type: 'select', required: true, options: Array.from({length: 12}, (_, i) => i + 1) },
                { id: 'year', type: 'select', required: true, options: Array.from({length: 100}, (_, i) => new Date().getFullYear() - i) },
                { id: 'gender', type: 'select', required: true, options: ['gender_male', 'gender_female', 'gender_other'] },
                { id: 'address', type: 'textarea', required: false },
                { id: 'phone', type: 'tel', required: false },
                { id: 'email', type: 'email', required: true }
            ]
        },
        {
            id: 'medical',
            questions: [
                { 
                    id: 'chronic_diseases', 
                    type: 'multiselect', 
                    required: false,
                    options: ['chronic_diabetes', 'chronic_hypertension', 'chronic_asthma', 'chronic_copd', 'chronic_heart', 'chronic_cancer', 'chronic_kidney', 'chronic_liver', 'chronic_thyroid']
                },
                { id: 'previous_surgeries', type: 'textarea', required: false },
                {
                    id: 'known_allergies',
                    type: 'multiselect',
                    required: false,
                    options: ['allergy_penicillin', 'allergy_aspirin', 'allergy_ibuprofen', 'allergy_latex', 'allergy_pollen', 'allergy_dust', 'allergy_food']
                },
                { id: 'current_medications', type: 'textarea', required: false }
            ]
        },
        {
            id: 'lifestyle',
            questions: [
                { 
                    id: 'smoking_status', 
                    type: 'select', 
                    required: true,
                    options: ['smoking_never', 'smoking_former', 'smoking_current']
                },
                { 
                    id: 'years_smoking', 
                    type: 'number', 
                    required: false,
                    condition: { field: 'smoking_status', operator: '==', value: 'smoking_current' }
                },
                {
                    id: 'alcohol_consumption',
                    type: 'select',
                    required: true,
                    options: ['alcohol_never', 'alcohol_occasionally', 'alcohol_regularly']
                },
                {
                    id: 'exercise_level',
                    type: 'select',
                    required: true,
                    options: ['exercise_none', 'exercise_light', 'exercise_moderate', 'exercise_intense']
                }
            ]
        },
        {
            id: 'symptoms',
            questions: [
                { id: 'main_complaint', type: 'textarea', required: true },
                {
                    id: 'symptom_duration',
                    type: 'select',
                    required: true,
                    options: ['duration_24h', 'duration_week', 'duration_month', 'duration_long']
                },
                { id: 'pain_level', type: 'number', required: false, min: 0, max: 10 },
                {
                    id: 'additional_symptoms',
                    type: 'multiselect',
                    required: false,
                    options: ['symptom_fever', 'symptom_cough', 'symptom_breath', 'symptom_nausea', 'symptom_dizziness', 'symptom_fatigue', 'symptom_headache']
                }
            ]
        },
        {
            id: 'family',
            questions: [
                {
                    id: 'family_diseases',
                    type: 'multiselect',
                    required: false,
                    options: ['family_diabetes', 'family_heart', 'family_cancer', 'family_mental', 'family_autoimmune']
                },
                { id: 'family_details', type: 'textarea', required: false }
            ]
        },
        {
            id: 'medications',
            questions: [
                { id: 'current_medications', type: 'textarea', required: false }
            ]
        },
        {
            id: 'consent',
            questions: [
                {
                    id: 'data_consent',
                    type: 'select',
                    required: true,
                    options: ['consent_yes', 'consent_no']
                },
                {
                    id: 'privacy_acceptance',
                    type: 'select',
                    required: true,
                    options: ['consent_accepted', 'consent_declined']
                }
            ]
        }
    ]
};

// =================================================================
// APPLICATION STATE
// =================================================================
const AppState = {
    currentSection: 0,
    answers: {},
    language: 'en',
    isDarkMode: false,
    privacyAccepted: false,
    documents: []
};

// =================================================================
// APPLICATION LOGIC
// =================================================================
const App = {
    init() {
        this.loadState();
        this.updateUI();
    },
    
    t(key) {
        return TRANSLATIONS[AppState.language][key] || TRANSLATIONS.en[key] || key;
    },
    
    updateUI() {
        // Update all translated elements
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            el.textContent = this.t(key);
        });
        
        // Update RTL for Arabic
        if (AppState.language === 'ar') {
            document.body.setAttribute('dir', 'rtl');
        } else {
            document.body.setAttribute('dir', 'ltr');
        }
        
        // Update theme
        if (AppState.isDarkMode) {
            document.body.classList.add('dark');
            document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        } else {
            document.body.classList.remove('dark');
            document.getElementById('theme-icon').textContent = 'üåô';
        }
        
        this.renderSection();
        this.updateProgress();
        this.updateNavigation();
    },
    
    acceptPrivacy() {
        AppState.privacyAccepted = true;
        document.getElementById('privacy-modal').classList.remove('active');
        document.getElementById('app-container').classList.remove('hidden');
        this.saveState();
        this.renderSection();
    },
    
    changeLanguage(lang) {
        AppState.language = lang;
        this.saveState();
        this.updateUI();
    },
    
    toggleTheme() {
        AppState.isDarkMode = !AppState.isDarkMode;
        this.saveState();
        this.updateUI();
    },
    
    checkCondition(condition) {
        if (!condition) return true;
        
        const { field, operator, value } = condition;
        const answer = AppState.answers[field];
        
        if (answer === undefined || answer === null || answer === '') return false;
        
        switch (operator) {
            case '==': return answer == value;
            case '!=': return answer != value;
            case '>': return parseFloat(answer) > parseFloat(value);
            case '<': return parseFloat(answer) < parseFloat(value);
            case '>=': return parseFloat(answer) >= parseFloat(value);
            case '<=': return parseFloat(answer) <= parseFloat(value);
            case 'includes': return Array.isArray(answer) && answer.includes(value);
            default: return false;
        }
    },
    
    renderSection() {
        const section = QUESTION_DATA.sections[AppState.currentSection];
        const questionArea = document.getElementById('question-area');
        
        let html = `<h2>${this.t('section_' + section.id)}</h2>`;
        
        section.questions.forEach(q => {
            if (!this.checkCondition(q.condition)) {
                // Clear answer if condition not met
                if (AppState.answers[q.id]) {
                    delete AppState.answers[q.id];
                }
                return;
            }
            
            html += this.renderQuestion(q);
        });
        
        questionArea.innerHTML = html;
        
        // Attach event listeners
        questionArea.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', (e) => {
                this.handleAnswer(e.target);
            });
        });
        
        // For multiselect
        questionArea.querySelectorAll('.option-item').forEach(el => {
            el.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = el.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });
    },
    
    renderQuestion(q) {
        const label = this.t(q.id);
        const required = q.required ? '<span class="required-star">*</span>' : '';
        const value = AppState.answers[q.id] || '';
        
        let html = `<div class="form-group">`;
        html += `<label>${label}${required}</label>`;
        
        switch (q.type) {
            case 'text':
            case 'email':
            case 'tel':
                html += `<input type="${q.type}" id="${q.id}" value="${value}" ${q.required ? 'required' : ''}>`;
                break;
                
            case 'number':
                html += `<input type="number" id="${q.id}" value="${value}" min="${q.min || 0}" max="${q.max || 999}" ${q.required ? 'required' : ''}>`;
                break;
                
            case 'textarea':
                html += `<textarea id="${q.id}" ${q.required ? 'required' : ''}>${value}</textarea>`;
                break;
                
            case 'select':
                html += `<select id="${q.id}" ${q.required ? 'required' : ''}>`;
                html += `<option value="">${this.t('please_select')}</option>`;
                if (q.id === 'day' || q.id === 'month' || q.id === 'year') {
                    q.options.forEach(opt => {
                        html += `<option value="${opt}" ${value == opt ? 'selected' : ''}>${opt}</option>`;
                    });
                } else {
                    q.options.forEach(opt => {
                        html += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${this.t(opt)}</option>`;
                    });
                }
                html += `</select>`;
                break;
                
            case 'multiselect':
                html += `<div class="options-grid">`;
                const selected = Array.isArray(value) ? value : [];
                q.options.forEach(opt => {
                    const checked = selected.includes(opt) ? 'checked' : '';
                    const selectedClass = selected.includes(opt) ? 'selected' : '';
                    html += `<label class="option-item ${selectedClass}">`;
                    html += `<input type="checkbox" name="${q.id}" value="${opt}" ${checked}>`;
                    html += `<span>${this.t(opt)}</span>`;
                    html += `</label>`;
                });
                html += `</div>`;
                break;
        }
        
        html += `</div>`;
        return html;
    },
    
    handleAnswer(element) {
        const id = element.id || element.name;
        
        if (element.type === 'checkbox') {
            const checkboxes = document.querySelectorAll(`input[name="${id}"]:checked`);
            AppState.answers[id] = Array.from(checkboxes).map(cb => cb.value);
            
            // Update selected state
            checkboxes.forEach(cb => {
                cb.closest('.option-item').classList.add('selected');
            });
            document.querySelectorAll(`input[name="${id}"]:not(:checked)`).forEach(cb => {
                cb.closest('.option-item').classList.remove('selected');
            });
        } else {
            AppState.answers[id] = element.value;
        }
        
        this.saveState();
        this.updateNavigation();
        this.renderSection(); // Re-render to handle conditional questions
    },
    
    isCurrentSectionValid() {
        const section = QUESTION_DATA.sections[AppState.currentSection];
        
        for (const q of section.questions) {
            if (!this.checkCondition(q.condition)) continue;
            
            if (q.required) {
                const answer = AppState.answers[q.id];
                if (!answer || (Array.isArray(answer) && answer.length === 0) || answer === '') {
                    return false;
                }
            }
        }
        
        return true;
    },
    
    updateProgress() {
        const total = QUESTION_DATA.sections.length;
        const current = AppState.currentSection + 1;
        const percent = Math.round((current / total) * 100);
        
        document.getElementById('progress-current').textContent = current;
        document.getElementById('progress-total').textContent = total;
        document.getElementById('progress-fill').style.width = percent + '%';
    },
    
    updateNavigation() {
        const isFirst = AppState.currentSection === 0;
        const isLast = AppState.currentSection === QUESTION_DATA.sections.length - 1;
        const isValid = this.isCurrentSectionValid();
        
        document.getElementById('prev-btn').disabled = isFirst;
        document.getElementById('next-btn').classList.toggle('hidden', isLast);
        document.getElementById('next-btn').disabled = !isValid;
        document.getElementById('finish-btn').classList.toggle('hidden', !isLast);
        document.getElementById('finish-btn').disabled = !isValid;
    },
    
    nextSection() {
        if (!this.isCurrentSectionValid()) {
            alert(this.t('required_fields'));
            return;
        }
        
        if (AppState.currentSection < QUESTION_DATA.sections.length - 1) {
            AppState.currentSection++;
            this.saveState();
            this.updateUI();
            window.scrollTo(0, 0);
        }
    },
    
    prevSection() {
        if (AppState.currentSection > 0) {
            AppState.currentSection--;
            this.saveState();
            this.updateUI();
            window.scrollTo(0, 0);
        }
    },
    
    finish() {
        if (!this.isCurrentSectionValid()) {
            alert(this.t('required_fields'));
            return;
        }
        
        this.showSummary();
        document.getElementById('export-area').classList.remove('hidden');
        this.updateEncryptedOutput();
    },
    
    showSummary() {
        const summaryBox = document.getElementById('summary-box');
        const summaryContent = document.getElementById('summary-content');
        
        let html = '';
        
        QUESTION_DATA.sections.forEach((section, sectionIdx) => {
            section.questions.forEach(q => {
                const answer = AppState.answers[q.id];
                if (answer && (Array.isArray(answer) ? answer.length > 0 : answer !== '')) {
                    let displayValue = answer;
                    if (Array.isArray(answer)) {
                        displayValue = answer.map(v => this.t(v)).join(', ');
                    } else if (q.type === 'select' && q.options && !['day', 'month', 'year'].includes(q.id)) {
                        displayValue = this.t(answer);
                    }
                    
                    html += `<div class="summary-item" onclick="App.goToSection(${sectionIdx})">`;
                    html += `<div class="summary-label">${this.t(q.id)}</div>`;
                    html += `<div class="summary-value">${displayValue}</div>`;
                    html += `</div>`;
                }
            });
        });
        
        summaryContent.innerHTML = html || '<p>No answers recorded.</p>';
        summaryBox.classList.remove('hidden');
    },
    
    goToSection(index) {
        AppState.currentSection = index;
        document.getElementById('summary-box').classList.add('hidden');
        document.getElementById('export-area').classList.add('hidden');
        this.saveState();
        this.updateUI();
        window.scrollTo(0, 0);
    },
    
    async updateEncryptedOutput() {
        const data = {
            version: '6.0',
            timestamp: new Date().toISOString(),
            language: AppState.language,
            answers: AppState.answers,
            documents: AppState.documents
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const encrypted = await encryptData(jsonString);
        document.getElementById('json-output').value = encrypted;
    },
    
    async exportEncrypted() {
        const data = {
            version: '6.0',
            timestamp: new Date().toISOString(),
            language: AppState.language,
            answers: AppState.answers,
            documents: AppState.documents
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const encrypted = await encryptData(jsonString);
        
        this.downloadFile(encrypted, 'anamnese_encrypted.txt', 'text/plain');
    },
    
    exportPlain() {
        const data = {
            version: '6.0',
            timestamp: new Date().toISOString(),
            language: AppState.language,
            answers: AppState.answers,
            documents: AppState.documents
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        this.downloadFile(jsonString, 'anamnese_plain.json', 'application/json');
    },
    
    async sendEmail() {
        const data = {
            version: '6.0',
            timestamp: new Date().toISOString(),
            language: AppState.language,
            answers: AppState.answers
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const encrypted = await encryptData(jsonString);
        
        const subject = encodeURIComponent(this.t('email_subject'));
        const body = encodeURIComponent(this.t('email_body') + '\n\n' + encrypted);
        
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    },
    
    async exportNFC() {
        if ('NDEFReader' in window) {
            try {
                const data = {
                    version: '6.0',
                    timestamp: new Date().toISOString(),
                    answers: AppState.answers
                };
                
                const jsonString = JSON.stringify(data);
                const encrypted = await encryptData(jsonString);
                
                const reader = new NDEFReader();
                await reader.write({
                    records: [{ recordType: "text", data: encrypted }]
                });
                
                alert(this.t('nfc_success'));
            } catch (e) {
                alert(this.t('nfc_error') + e.message);
            }
        } else {
            alert(this.t('nfc_simulation'));
        }
    },
    
    showDecryptModal() {
        document.getElementById('decrypt-modal').classList.add('active');
    },
    
    closeDecryptModal() {
        document.getElementById('decrypt-modal').classList.remove('active');
        document.getElementById('decrypt-input').value = '';
    },
    
    async decrypt() {
        const input = document.getElementById('decrypt-input').value.trim();
        
        if (!input) {
            alert('Please paste encrypted data');
            return;
        }
        
        try {
            const decrypted = await decryptData(input);
            const data = JSON.parse(decrypted);
            
            alert('Decryption successful!\n\n' + JSON.stringify(data, null, 2));
            this.closeDecryptModal();
        } catch (e) {
            alert('Decryption failed: ' + e.message);
        }
    },
    
    async processDocuments(event) {
        const files = Array.from(event.target.files);
        
        for (const file of files) {
            try {
                let text = '';
                
                if (file.type === 'application/pdf') {
                    text = await this.extractPDFText(file);
                } else if (file.type.startsWith('image/')) {
                    text = await this.performOCR(file);
                } else if (file.type.startsWith('text/')) {
                    text = await file.text();
                }
                
                AppState.documents.push({
                    filename: file.name,
                    text: text,
                    timestamp: new Date().toISOString()
                });
                
                this.saveState();
            } catch (e) {
                alert(`Error processing ${file.name}: ${e.message}`);
            }
        }
        
        if (files.length > 0) {
            alert(`Processed ${files.length} document(s)`);
            await this.updateEncryptedOutput();
        }
        
        event.target.value = '';
    },
    
    async extractPDFText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }
        
        return fullText.trim();
    },
    
    async performOCR(file) {
        const result = await Tesseract.recognize(file, 'deu+eng', {
            logger: m => console.log(m)
        });
        return result.data.text;
    },
    
    downloadFile(content, filename, type) {
        const blob = new Blob([content], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    },
    
    saveProgress() {
        const data = {
            version: '6.0',
            timestamp: new Date().toISOString(),
            language: AppState.language,
            answers: AppState.answers
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        this.downloadFile(jsonString, 'anamnese_progress.json', 'application/json');
        alert(this.t('data_saved'));
    },
    
    async loadProgress(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.answers) {
                AppState.answers = data.answers;
                if (data.language) AppState.language = data.language;
                this.saveState();
                this.updateUI();
                alert(this.t('data_loaded'));
            }
        } catch (e) {
            alert('Error loading file: ' + e.message);
        }
        
        event.target.value = '';
    },
    
    saveState() {
        try {
            localStorage.setItem('anamnese_v6_state', JSON.stringify(AppState));
        } catch (e) {
            console.error('Could not save to localStorage:', e);
        }
    },
    
    loadState() {
        try {
            const saved = localStorage.getItem('anamnese_v6_state');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(AppState, data);
            }
        } catch (e) {
            console.error('Could not load from localStorage:', e);
        }
    }
};

// Initialize on page load
window.addEventListener('DOMContentLoaded', () => {
    App.init();
    
    // If privacy already accepted, show app
    if (AppState.privacyAccepted) {
        document.getElementById('privacy-modal').classList.remove('active');
        document.getElementById('app-container').classList.remove('hidden');
        App.renderSection();
    }
});

    </script>
</body>
</html>
