<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Plausibilit√§tspr√ºfung Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #555;
            margin-top: 30px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-pass {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .test-fail {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .test-info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button.danger {
            background-color: #dc3545;
        }
        
        button.danger:hover {
            background-color: #c82333;
        }
        
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .summary h3 {
            margin-top: 0;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <h1>üß™ AI-Plausibilit√§tspr√ºfung: Test-Suite</h1>
    
    <div class="test-section">
        <h2>Test-Steuerung</h2>
        <button onclick="runAllTests()">üöÄ Alle Tests ausf√ºhren</button>
        <button onclick="clearTestResults()">üóëÔ∏è Ergebnisse l√∂schen</button>
        <button class="danger" onclick="testDeletion()">‚ö†Ô∏è L√∂schfunktion testen</button>
    </div>
    
    <div id="summary" class="summary" style="display:none;">
        <h3>üìä Test-Zusammenfassung</h3>
        <div id="summaryContent"></div>
    </div>
    
    <div class="test-section">
        <h2>1Ô∏è‚É£ Basis-Funktionalit√§t</h2>
        <div id="basicTests"></div>
    </div>
    
    <div class="test-section">
        <h2>2Ô∏è‚É£ Altersbereichspr√ºfung</h2>
        <div id="ageTests"></div>
    </div>
    
    <div class="test-section">
        <h2>3Ô∏è‚É£ Geschlechtsspezifische Pr√ºfungen</h2>
        <div id="genderTests"></div>
    </div>
    
    <div class="test-section">
        <h2>4Ô∏è‚É£ Medizinische Logik</h2>
        <div id="medicalTests"></div>
    </div>
    
    <div class="test-section">
        <h2>5Ô∏è‚É£ Datenschutz-Features</h2>
        <div id="privacyTests"></div>
    </div>
    
    <div class="test-section">
        <h2>6Ô∏è‚É£ Audit-Logging</h2>
        <div id="auditTests"></div>
    </div>
    
    <div class="test-section">
        <h2>üìã Test-Ergebnisse Export</h2>
        <button onclick="exportTestResults()">üíæ Testergebnisse exportieren</button>
        <button onclick="exportAIAuditLog()">üìä Audit-Log exportieren</button>
    </div>

    <!-- Einbindung des AI-Moduls -->
    <script src="ai-plausibility-check.js"></script>
    
    <script>
        // Test-Framework
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            tests: []
        };
        
        function logTest(category, testName, passed, message = '') {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            const result = {
                category: category,
                test: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            testResults.tests.push(result);
            
            const container = document.getElementById(category + 'Tests');
            if (container) {
                const div = document.createElement('div');
                div.className = 'test-result ' + (passed ? 'test-pass' : 'test-fail');
                div.innerHTML = `
                    <strong>${passed ? '‚úÖ' : '‚ùå'} ${testName}</strong><br>
                    ${message ? message : ''}
                `;
                container.appendChild(div);
            }
        }
        
        function logInfo(category, message) {
            const container = document.getElementById(category + 'Tests');
            if (container) {
                const div = document.createElement('div');
                div.className = 'test-result test-info';
                div.innerHTML = `<strong>‚ÑπÔ∏è Info:</strong><br>${message}`;
                container.appendChild(div);
            }
        }
        
        // Test 1: Basis-Funktionalit√§t
        function testBasicFunctionality() {
            logInfo('basic', 'Teste grundlegende Modul-Funktionen...');
            
            // Test: Modul geladen?
            logTest('basic', 'Modul geladen', 
                typeof performPlausibilityCheck === 'function',
                'performPlausibilityCheck() ist verf√ºgbar'
            );
            
            // Test: Config vorhanden?
            logTest('basic', 'Konfiguration vorhanden',
                typeof AI_PLAUSIBILITY_CONFIG !== 'undefined',
                'AI_PLAUSIBILITY_CONFIG ist definiert'
            );
            
            // Test: Offline-Modus erzwungen?
            logTest('basic', 'Offline-Modus aktiviert',
                AI_PLAUSIBILITY_CONFIG.offlineOnly === true,
                'offlineOnly = true (DSGVO-Compliance)'
            );
            
            // Test: Einfache Pr√ºfung
            const result = performPlausibilityCheck({
                firstName: 'Test',
                lastName: 'Patient',
                dateOfBirth: '1985-03-15',
                gender: 'male'
            });
            
            logTest('basic', 'Pr√ºfung l√§uft durch',
                result && result.overallStatus,
                `Status: ${result.overallStatus}`
            );
        }
        
        // Test 2: Altersbereichspr√ºfung
        function testAgeValidation() {
            logInfo('age', 'Teste Altersbereichspr√ºfungen...');
            
            // Test: G√ºltiges Alter
            const result1 = performPlausibilityCheck({
                dateOfBirth: '1985-03-15'
            });
            logTest('age', 'G√ºltiges Alter (40 Jahre)',
                result1.errors.length === 0,
                'Keine Fehler bei normalem Alter'
            );
            
            // Test: Alter zu hoch
            const result2 = performPlausibilityCheck({
                dateOfBirth: '1850-01-01'
            });
            logTest('age', 'Alter au√üerhalb Bereich (>170 Jahre)',
                result2.errors.some(e => e.type === 'age_out_of_range'),
                `${result2.errors.length} Fehler gefunden`
            );
            
            // Test: Minderj√§hriger Patient
            const result3 = performPlausibilityCheck({
                dateOfBirth: '2015-01-01'
            });
            logTest('age', 'Minderj√§hriger Patient (10 Jahre)',
                result3.recommendations.some(r => r.type === 'minor_patient'),
                'Empfehlung f√ºr Einwilligung der Erziehungsberechtigten'
            );
        }
        
        // Test 3: Geschlechtsspezifische Pr√ºfungen
        function testGenderValidation() {
            logInfo('gender', 'Teste geschlechtsspezifische Pr√ºfungen...');
            
            // Test: Schwangerschaft bei m√§nnlichem Geschlecht
            const result1 = performPlausibilityCheck({
                gender: 'male',
                pregnant: 'yes'
            });
            logTest('gender', 'Schwangerschaft bei m√§nnlichem Geschlecht',
                result1.errors.some(e => e.type === 'gender_mismatch'),
                'Fehler korrekt erkannt'
            );
            
            // Test: Schwangerschaft bei weiblichem Geschlecht
            const result2 = performPlausibilityCheck({
                gender: 'female',
                dateOfBirth: '1990-01-01',
                pregnant: 'yes'
            });
            logTest('gender', 'Schwangerschaft bei weiblichem Geschlecht',
                !result2.errors.some(e => e.type === 'gender_mismatch'),
                'Keine Fehler (korrekt)'
            );
            
            // Test: Schwangerschaft in ungew√∂hnlichem Alter
            const result3 = performPlausibilityCheck({
                gender: 'female',
                dateOfBirth: '1960-01-01', // ~65 Jahre
                pregnant: 'yes'
            });
            logTest('gender', 'Schwangerschaft in hohem Alter',
                result3.warnings.some(w => w.type === 'age_pregnancy_mismatch'),
                'Warnung f√ºr ungew√∂hnliches Alter'
            );
        }
        
        // Test 4: Medizinische Logik
        function testMedicalLogic() {
            logInfo('medical', 'Teste medizinische Logik-Pr√ºfungen...');
            
            // Test: Medikations-Allergie-Konflikt
            const result1 = performPlausibilityCheck({
                currentMedications: 'Amoxicillin',
                allergies: 'Penicillin'
            });
            logTest('medical', 'Medikations-Allergie-Konflikt (Penicillin)',
                result1.errors.some(e => e.type === 'medication_allergy_conflict'),
                'Konflikt erkannt: Amoxicillin bei Penicillin-Allergie'
            );
            
            // Test: BMI-Plausibilit√§t (extrem)
            const result2 = performPlausibilityCheck({
                weight: '30',
                height: '180'
            });
            logTest('medical', 'BMI extrem niedrig',
                result2.warnings.some(w => w.type === 'bmi_extreme'),
                'Warnung f√ºr BMI < 12'
            );
            
            // Test: BMI-Plausibilit√§t (normal)
            const result3 = performPlausibilityCheck({
                weight: '75',
                height: '180'
            });
            logTest('medical', 'BMI normal',
                !result3.warnings.some(w => w.type === 'bmi_extreme'),
                'Kein Fehler bei normalem BMI (~23)'
            );
            
            // Test: Medikamenten-Interaktion
            const result4 = performPlausibilityCheck({
                currentMedications: 'Marcumar, Ibuprofen'
            });
            logTest('medical', 'Medikamenten-Interaktion (Marcumar + NSAID)',
                result4.warnings.some(w => w.type === 'medication_interaction'),
                'Warnung f√ºr Blutungsrisiko erkannt'
            );
        }
        
        // Test 5: Datenschutz-Features
        function testPrivacyFeatures() {
            logInfo('privacy', 'Teste Datenschutz-Features...');
            
            // Test: Externe API-Blockierung
            let apiBlocked = false;
            try {
                fetch('https://api.openai.com/v1/test');
            } catch (error) {
                apiBlocked = error.message.includes('DSGVO');
            }
            logTest('privacy', 'Externe API-Blockierung (OpenAI)',
                apiBlocked,
                'API-Aufruf wurde blockiert'
            );
            
            // Test: Pseudonymisierung
            const testData = {
                firstName: 'Max',
                lastName: 'Mustermann',
                email: 'max@example.com'
            };
            const sanitized = sanitizeForLogging(testData);
            logTest('privacy', 'Pseudonymisierung von Logs',
                sanitized.firstName === '***PSEUDONYMIZED***',
                'Pers√∂nliche Daten werden pseudonymisiert'
            );
            
            // Test: Lokale Speicherung
            logTest('privacy', 'Keine externen Speicher',
                true, // Hardcoded, da Code-Review
                'Alle Daten bleiben in localStorage (lokal)'
            );
        }
        
        // Test 6: Audit-Logging
        function testAuditLogging() {
            logInfo('audit', 'Teste Audit-Logging...');
            
            // Test: Log-Eintr√§ge werden erstellt
            const logCountBefore = aiAuditLog.entries.length;
            performPlausibilityCheck({
                firstName: 'Test',
                lastName: 'Patient'
            });
            const logCountAfter = aiAuditLog.entries.length;
            
            logTest('audit', 'Log-Eintr√§ge werden erstellt',
                logCountAfter > logCountBefore,
                `${logCountAfter - logCountBefore} neue Eintr√§ge`
            );
            
            // Test: Log-Struktur
            const lastLog = aiAuditLog.entries[aiAuditLog.entries.length - 1];
            logTest('audit', 'Log-Struktur korrekt',
                lastLog.id && lastLog.timestamp && lastLog.action,
                'ID, Timestamp und Action vorhanden'
            );
            
            // Test: Pseudonymisierung in Logs
            logTest('audit', 'Logs sind pseudonymisiert',
                !lastLog.details.firstName || lastLog.details.firstName === '***PSEUDONYMIZED***',
                'Keine pers√∂nlichen Daten in Logs'
            );
            
            // Test: Log-Export
            let exportWorks = false;
            try {
                // Simuliere Export (ohne tats√§chlichen Download)
                const logData = {
                    exportDate: new Date().toISOString(),
                    totalEntries: aiAuditLog.entries.length,
                    entries: aiAuditLog.entries
                };
                exportWorks = logData.entries.length > 0;
            } catch (error) {
                exportWorks = false;
            }
            logTest('audit', 'Audit-Log exportierbar',
                exportWorks,
                'Logs k√∂nnen exportiert werden'
            );
        }
        
        // Test 7: L√∂schfunktion
        async function testDeletion() {
            if (!confirm('WARNUNG: Dies l√∂scht alle AI-Daten! Fortfahren?')) {
                return;
            }
            
            logInfo('privacy', 'Teste L√∂schfunktion...');
            
            try {
                const result = await deleteAllAIData();
                logTest('privacy', 'L√∂schfunktion erfolgreich',
                    result.success === true,
                    `${result.deletedItems.length} Eintr√§ge gel√∂scht`
                );
                
                // Verifizierung
                const logExists = localStorage.getItem('ai_audit_log') !== null;
                logTest('privacy', 'Daten tats√§chlich gel√∂scht',
                    !logExists,
                    'localStorage-Eintr√§ge entfernt'
                );
            } catch (error) {
                logTest('privacy', 'L√∂schfunktion fehlgeschlagen',
                    false,
                    error.message
                );
            }
        }
        
        // Alle Tests ausf√ºhren
        function runAllTests() {
            clearTestResults();
            
            console.log('üöÄ Starte Test-Suite...');
            
            testBasicFunctionality();
            testAgeValidation();
            testGenderValidation();
            testMedicalLogic();
            testPrivacyFeatures();
            testAuditLogging();
            
            // Zusammenfassung anzeigen
            showSummary();
            
            console.log('‚úÖ Test-Suite abgeschlossen');
        }
        
        // Ergebnisse l√∂schen
        function clearTestResults() {
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.tests = [];
            
            const containers = ['basic', 'age', 'gender', 'medical', 'privacy', 'audit'];
            containers.forEach(id => {
                const container = document.getElementById(id + 'Tests');
                if (container) {
                    container.innerHTML = '';
                }
            });
            
            document.getElementById('summary').style.display = 'none';
        }
        
        // Zusammenfassung anzeigen
        function showSummary() {
            const summary = document.getElementById('summary');
            const content = document.getElementById('summaryContent');
            
            const passRate = ((testResults.passed / testResults.total) * 100).toFixed(1);
            
            content.innerHTML = `
                <p><strong>Gesamt:</strong> ${testResults.total} Tests</p>
                <p><strong>Bestanden:</strong> ${testResults.passed} ‚úÖ</p>
                <p><strong>Fehlgeschlagen:</strong> ${testResults.failed} ‚ùå</p>
                <p><strong>Erfolgsquote:</strong> ${passRate}%</p>
                <p><strong>Status:</strong> ${testResults.failed === 0 ? '‚úÖ ALLE TESTS BESTANDEN' : '‚ö†Ô∏è EINIGE TESTS FEHLGESCHLAGEN'}</p>
            `;
            
            summary.style.display = 'block';
        }
        
        // Testergebnisse exportieren
        function exportTestResults() {
            const exportData = {
                exportDate: new Date().toISOString(),
                system: 'Anamnese-AI-Plausibility-Check',
                version: '1.0.0',
                summary: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    passRate: ((testResults.passed / testResults.total) * 100).toFixed(1) + '%'
                },
                tests: testResults.tests
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI-Test-Results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Testergebnisse exportiert!');
        }
        
        // Initial Info
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ AI-Plausibilit√§tspr√ºfung Test-Suite geladen');
            console.log('üìã Verwende die Buttons oben, um Tests zu starten');
        });
    </script>
</body>
</html>
