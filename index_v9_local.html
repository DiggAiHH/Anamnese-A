<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Medizinische Anamnese - DSGVO-konform und offline-f√§hig">
    <meta name="author" content="DiggAi GmbH">
    <title>Medizinische Anamnese v9</title>
    
    <!-- External Libraries (CDN only - no local dependencies) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        }
    </script>
    
    <style>
        /* ========================================
           INLINE STYLES - Clean HTML/CSS Design
           ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --border-color: #dee2e6;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.95;
            margin-top: 0.5rem;
        }
        
        /* Language Selector */
        .language-selector {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        
        .language-selector label {
            font-size: 1rem;
            font-weight: 500;
        }
        
        .language-selector select {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            background: white;
            color: #333;
            transition: var(--transition);
        }
        
        .language-selector select:hover {
            border-color: white;
        }
        
        /* Progress Bar */
        .progress-container {
            padding: 1.5rem 2rem;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border-color);
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }
        
        .progress-bar-wrapper {
            width: 100%;
            height: 12px;
            background: var(--medium-gray);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.4s ease;
            border-radius: 6px;
        }
        
        /* Question Section */
        .question-section {
            padding: 2.5rem;
        }
        
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--primary-color);
        }
        
        /* Question Card */
        .question-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }
        
        .question-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }
        
        .question-label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .question-required {
            color: var(--danger-color);
            margin-left: 0.25rem;
        }
        
        /* Input Fields */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Checkbox and Radio Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .option-item:hover {
            background: var(--light-gray);
            border-color: var(--primary-color);
        }
        
        .option-item.selected {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
        }
        
        .option-item input[type="checkbox"],
        .option-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            cursor: pointer;
        }
        
        .option-item label {
            flex: 1;
            cursor: pointer;
            font-size: 1rem;
        }
        
        /* Date Select */
        .date-select-wrapper {
            display: flex;
            gap: 0.75rem;
        }
        
        .date-select-wrapper select {
            flex: 1;
        }
        
        /* Navigation Buttons */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 2rem;
            background: var(--light-gray);
            border-top: 1px solid var(--border-color);
        }
        
        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: var(--dark-gray);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #343a40;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(73, 80, 87, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Export Section */
        .export-section {
            padding: 2rem;
            background: var(--light-gray);
            border-top: 1px solid var(--border-color);
        }
        
        .export-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }
        
        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        .btn-info {
            background: var(--info-color);
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .modal-close {
            font-size: 2rem;
            font-weight: 300;
            color: var(--dark-gray);
            cursor: pointer;
            line-height: 1;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        /* Footer */
        footer {
            background: var(--light-gray);
            padding: 1.5rem;
            text-align: center;
            color: var(--dark-gray);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
        }
        
        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Privacy Notice */
        .privacy-notice {
            padding: 2rem;
            text-align: center;
        }
        
        .privacy-notice h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .privacy-notice p {
            margin-bottom: 1.5rem;
            line-height: 1.8;
        }
        
        .privacy-consent {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }
        
        .privacy-consent input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .privacy-consent label {
            font-size: 1rem;
            cursor: pointer;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .question-section {
                padding: 1.5rem;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .date-select-wrapper {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
        
        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid var(--medium-gray);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hidden State */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Privacy Notice -->
        <div id="privacy-screen" class="privacy-notice">
            <h2>üîí Datenschutzhinweis</h2>
            <p>
                Diese Anwendung verarbeitet Ihre Gesundheitsdaten <strong>ausschlie√ülich lokal</strong> 
                auf Ihrem Ger√§t. Es werden <strong>keine Daten an externe Server</strong> √ºbermittelt 
                (au√üer f√ºr das einmalige Laden der Bibliotheken, falls online).
            </p>
            <p>
                Alle Ihre Eingaben werden verschl√ºsselt gespeichert und k√∂nnen nur mit Ihrem Passwort 
                entschl√ºsselt werden.
            </p>
            <div class="privacy-consent">
                <input type="checkbox" id="privacy-checkbox">
                <label for="privacy-checkbox">
                    Ich habe die Informationen gelesen und stimme der lokalen Verarbeitung zu.
                </label>
            </div>
            <button id="start-btn" class="btn btn-primary" disabled>
                Akzeptieren & Starten
            </button>
        </div>
        
        <!-- Main Application (hidden initially) -->
        <div id="app-container" class="hidden">
            <!-- Header -->
            <header>
                <h1>Medizinische Anamnese</h1>
                <p>Sichere und verschl√ºsselte Datenerfassung</p>
                
                <div class="language-selector">
                    <label for="language">Sprache / Language:</label>
                    <select id="language">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="it">Italiano</option>
                        <option value="pt">Portugu√™s</option>
                        <option value="nl">Nederlands</option>
                        <option value="pl">Polski</option>
                        <option value="tr">T√ºrk√ße</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                </div>
            </header>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-info">
                    <span id="progress-text">Schritt 1 von 7</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Question Section -->
            <div class="question-section">
                <h2 id="section-title" class="section-title">Basisdaten</h2>
                <div id="questions-container"></div>
            </div>
            
            <!-- Navigation -->
            <div class="navigation-buttons">
                <button id="prev-btn" class="btn btn-secondary">‚Üê Zur√ºck</button>
                <button id="next-btn" class="btn btn-primary">Weiter ‚Üí</button>
            </div>
            
            <!-- Export Section (shown at the end) -->
            <div id="export-section" class="export-section hidden">
                <h3 class="export-title">Ihre Anamnese ist vollst√§ndig!</h3>
                <p>Sie k√∂nnen Ihre Daten jetzt verschl√ºsselt exportieren:</p>
                <div class="export-buttons">
                    <button id="export-encrypted-btn" class="btn btn-success">
                        üîí Verschl√ºsselt Speichern
                    </button>
                    <button id="export-json-btn" class="btn btn-info">
                        üì• Als JSON Exportieren
                    </button>
                    <button id="upload-documents-btn" class="btn btn-info">
                        üìÑ Dokumente Hochladen
                    </button>
                    <button id="view-documents-btn" class="btn btn-secondary">
                        üëÅÔ∏è Dokumente Anzeigen
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <footer>
                <p>
                    <strong>Datenschutzkonforme lokale Anamnese v9</strong><br>
                    Alle Daten bleiben auf Ihrem Ger√§t ‚Ä¢ Keine externe √úbertragung ‚Ä¢ 
                    AES-256 Verschl√ºsselung
                </p>
            </footer>
        </div>
        
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Wird geladen...</p>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Verschl√ºsselung</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Bitte geben Sie ein Passwort ein, um Ihre Daten zu verschl√ºsseln:</p>
                <input type="password" id="encryption-password" placeholder="Passwort">
            </div>
            <div class="modal-footer">
                <button id="modal-cancel" class="btn btn-secondary">Abbrechen</button>
                <button id="modal-confirm" class="btn btn-primary">Best√§tigen</button>
            </div>
        </div>
    </div>
    
    <script>
        /* ========================================
           INLINE JAVASCRIPT - TRANSLATIONS
           ======================================== */
        
        const translations = {
            de: {
                title: "Medizinische Anamnese",
                langLabel: "Sprache / Language:",
                sectionPersonal: "Pers√∂nliche Daten",
                sectionComplaints: "Aktuelle Beschwerden",
                sectionSymptoms: "Allgemeine Symptome",
                sectionHistory: "Vorerkrankungen & OPs",
                sectionMedications: "Medikamente & Allergien",
                sectionLifestyle: "Lebensstil & Soziales",
                labelFirstName: "Vorname:",
                labelLastName: "Nachname:",
                labelDateOfBirth: "Geburtsdatum:",
                labelGender: "Geschlecht:",
                labelAddress: "Adresse:",
                labelPhone: "Telefon:",
                labelEmail: "E-Mail:",
                labelCurrentComplaints: "Aktuelle Beschwerden:",
                labelPastIllnesses: "Fr√ºhere Erkrankungen:",
                labelSurgeries: "Operationen:",
                labelMedications: "Aktuelle Medikamente:",
                labelAllergies: "Allergien:",
                labelFamilyHistory: "Familienanamnese:",
                labelSmoking: "Rauchen:",
                labelAlcohol: "Alkoholkonsum:",
                labelExercise: "K√∂rperliche Aktivit√§t:",
                labelAdditionalNotes: "Weitere Anmerkungen:",
                optionSelect: "Bitte w√§hlen",
                optionMale: "M√§nnlich",
                optionFemale: "Weiblich",
                optionOther: "Divers",
                optionNever: "Nie",
                optionFormer: "Ehemals",
                optionCurrent: "Aktuell",
                optionAlcoholNever: "Nie",
                optionOccasional: "Gelegentlich",
                optionRegular: "Regelm√§√üig",
                btnPrevious: "‚Üê Zur√ºck",
                btnNext: "Weiter ‚Üí",
                btnSave: "Verschl√ºsselt Speichern",
                btnExport: "Als JSON Exportieren",
                btnUploadDocs: "Dokumente Hochladen",
                btnViewDocs: "Dokumente Anzeigen",
                footerText: "Datenschutzkonforme lokale Anamnese - Alle Daten bleiben auf Ihrem Ger√§t",
                modalTitle: "Verschl√ºsselung",
                modalText: "Bitte geben Sie ein Passwort ein:",
                modalConfirm: "Best√§tigen",
                modalCancel: "Abbrechen",
                alertSaved: "Daten erfolgreich verschl√ºsselt und gespeichert!",
                alertExported: "JSON-Datei wurde heruntergeladen!",
                alertPassword: "Bitte geben Sie ein Passwort ein!",
                stepText: "Schritt {current} von {total}",
                completeTitle: "Ihre Anamnese ist vollst√§ndig!",
                completeText: "Sie k√∂nnen Ihre Daten jetzt verschl√ºsselt exportieren:"
            },
            en: {
                title: "Medical History",
                langLabel: "Language:",
                sectionPersonal: "Personal Information",
                sectionComplaints: "Current Complaints",
                sectionSymptoms: "General Symptoms",
                sectionHistory: "Medical History & Surgeries",
                sectionMedications: "Medications & Allergies",
                sectionLifestyle: "Lifestyle & Social",
                labelFirstName: "First Name:",
                labelLastName: "Last Name:",
                labelDateOfBirth: "Date of Birth:",
                labelGender: "Gender:",
                labelAddress: "Address:",
                labelPhone: "Phone:",
                labelEmail: "Email:",
                labelCurrentComplaints: "Current Complaints:",
                labelPastIllnesses: "Past Illnesses:",
                labelSurgeries: "Surgeries:",
                labelMedications: "Current Medications:",
                labelAllergies: "Allergies:",
                labelFamilyHistory: "Family History:",
                labelSmoking: "Smoking:",
                labelAlcohol: "Alcohol Consumption:",
                labelExercise: "Physical Activity:",
                labelAdditionalNotes: "Additional Notes:",
                optionSelect: "Please select",
                optionMale: "Male",
                optionFemale: "Female",
                optionOther: "Other",
                optionNever: "Never",
                optionFormer: "Former",
                optionCurrent: "Current",
                optionAlcoholNever: "Never",
                optionOccasional: "Occasional",
                optionRegular: "Regular",
                btnPrevious: "‚Üê Previous",
                btnNext: "Next ‚Üí",
                btnSave: "Save Encrypted",
                btnExport: "Export as JSON",
                btnUploadDocs: "Upload Documents",
                btnViewDocs: "View Documents",
                footerText: "Privacy-compliant local medical history - All data remains on your device",
                modalTitle: "Encryption",
                modalText: "Please enter a password:",
                modalConfirm: "Confirm",
                modalCancel: "Cancel",
                alertSaved: "Data successfully encrypted and saved!",
                alertExported: "JSON file has been downloaded!",
                alertPassword: "Please enter a password!",
                stepText: "Step {current} of {total}",
                completeTitle: "Your medical history is complete!",
                completeText: "You can now export your data encrypted:"
            }
        };
        
        let currentLanguage = 'de';
        
        function changeLanguage() {
            const lang = document.getElementById('language').value;
            currentLanguage = lang;
            const t = translations[lang] || translations.de;
            
            // Update UI text
            document.querySelector('header h1').textContent = t.title;
            document.querySelector('header p').textContent = t.footerText;
            
            // Re-render current section to update labels
            renderCurrentSection();
        }
        
        /* ========================================
           INLINE JAVASCRIPT - ENCRYPTION
           ======================================== */
        
        let currentAction = null;
        
        // Derive key from password using PBKDF2
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const passwordKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );
            
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                passwordKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }
        
        // Encrypt data with AES-256-GCM
        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const key = await deriveKey(password, salt);
            
            const encryptedData = await crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                key,
                encoder.encode(data)
            );
            
            // Combine salt, iv, and encrypted data
            const result = new Uint8Array(salt.length + iv.length + encryptedData.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encryptedData), salt.length + iv.length);
            
            // Convert to base64 for storage
            return btoa(String.fromCharCode.apply(null, result));
        }
        
        // Decrypt data with AES-256-GCM
        async function decryptData(encryptedBase64, password) {
            const decoder = new TextDecoder();
            
            // Decode from base64
            const encryptedArray = new Uint8Array(
                atob(encryptedBase64).split('').map(c => c.charCodeAt(0))
            );
            
            // Extract salt, iv, and encrypted data
            const salt = encryptedArray.slice(0, 16);
            const iv = encryptedArray.slice(16, 28);
            const data = encryptedArray.slice(28);
            
            const key = await deriveKey(password, salt);
            
            try {
                const decryptedData = await crypto.subtle.decrypt(
                    {
                        name: 'AES-GCM',
                        iv: iv
                    },
                    key,
                    data
                );
                
                return decoder.decode(decryptedData);
            } catch (e) {
                throw new Error('Decryption failed - incorrect password');
            }
        }
        
        /* ========================================
           INLINE JAVASCRIPT - OCR GDPR MODULE
           ======================================== */
        
        const OCR_AUDIT = {
            logs: [],
            
            log(action, filename, details = {}) {
                const logEntry = {
                    id: `OCR-LOG-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`,
                    timestamp: new Date().toISOString(),
                    action: action,
                    filename: filename,
                    fileSize: details.fileSize || null,
                    success: details.success !== false
                };
                
                this.logs.push(logEntry);
                console.log('OCR Audit:', logEntry);
                return logEntry;
            }
        };
        
        const DOCUMENT_STORAGE_GDPR = {
            documents: [],
            
            addDocument(docData) {
                const doc = {
                    id: `DOC-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`,
                    ...docData,
                    uploadTimestamp: new Date().toISOString()
                };
                
                this.documents.push(doc);
                OCR_AUDIT.log('document_uploaded', docData.filename, {
                    fileSize: docData.originalSize,
                    success: true
                });
                
                return doc;
            },
            
            getAllDocuments() {
                return [...this.documents];
            }
        };
        
        async function performOCRWithAudit(file) {
            OCR_AUDIT.log('ocr_started', file.name, {
                fileSize: file.size
            });
            
            try {
                const result = await Tesseract.recognize(
                    file,
                    'deu',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                console.log('OCR Progress:', Math.round(m.progress * 100) + '%');
                            }
                        }
                    }
                );
                
                const extractedText = result.data.text;
                
                OCR_AUDIT.log('ocr_completed', file.name, {
                    fileSize: file.size,
                    textLength: extractedText.length,
                    success: true
                });
                
                return extractedText;
            } catch (error) {
                OCR_AUDIT.log('ocr_failed', file.name, {
                    fileSize: file.size,
                    success: false
                });
                
                console.error('OCR failed:', error);
                throw new Error('Fehler bei der Texterkennung: ' + error.message);
            }
        }
        
        async function processUploadedFileWithGDPR(file) {
            const timestamp = new Date().toISOString();
            const fileType = file.type;
            
            let extractedText = '';
            let processType = '';
            
            try {
                if (fileType.startsWith('image/')) {
                    processType = 'ocr';
                    extractedText = await performOCRWithAudit(file);
                } else if (fileType.startsWith('text/')) {
                    processType = 'text-file';
                    extractedText = await file.text();
                } else {
                    throw new Error('Nicht unterst√ºtzter Dateityp: ' + fileType);
                }
                
                return {
                    filename: file.name,
                    text: extractedText,
                    timestamp: timestamp,
                    type: processType,
                    originalSize: file.size
                };
            } catch (error) {
                throw new Error('Fehler beim Verarbeiten von ' + file.name + ': ' + error.message);
            }
        }
        
        async function showDocumentUploadDialogGDPR() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.pdf,.txt';
            input.multiple = true;
            
            return new Promise((resolve) => {
                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) {
                        resolve({ success: false, message: 'Keine Dateien ausgew√§hlt' });
                        return;
                    }
                    
                    const processedDocs = [];
                    const errors = [];
                    
                    for (const file of files) {
                        try {
                            const docData = await processUploadedFileWithGDPR(file);
                            const doc = DOCUMENT_STORAGE_GDPR.addDocument(docData);
                            processedDocs.push(doc);
                        } catch (error) {
                            console.error('Fehler:', error);
                            errors.push({ filename: file.name, error: error.message });
                        }
                    }
                    
                    resolve({
                        success: processedDocs.length > 0,
                        processedCount: processedDocs.length,
                        errorCount: errors.length,
                        documents: processedDocs,
                        errors: errors
                    });
                };
                
                input.click();
            });
        }
        
        function showUploadedDocumentsGDPR() {
            const docs = DOCUMENT_STORAGE_GDPR.getAllDocuments();
            
            if (docs.length === 0) {
                alert('Keine Dokumente hochgeladen.');
                return;
            }
            
            let docList = docs.map((doc, i) => 
                `${i + 1}. ${doc.filename} (${(doc.originalSize / 1024).toFixed(1)} KB)`
            ).join('\n');
            
            alert('Hochgeladene Dokumente:\n\n' + docList);
        }
        
        /* ========================================
           APPLICATION DATA STRUCTURE
           ======================================== */
        
        const APP_DATA = {
            version: "9.0",
            sections: [
                {
                    id: "personal",
                    title: "Basisdaten / Pers√∂nliche Daten",
                    fields: [
                        {
                            id: "firstName",
                            type: "text",
                            label: "labelFirstName",
                            required: true
                        },
                        {
                            id: "lastName",
                            type: "text",
                            label: "labelLastName",
                            required: true
                        },
                        {
                            id: "gender",
                            type: "select",
                            label: "labelGender",
                            required: true,
                            options: [
                                { value: "male", label: "optionMale" },
                                { value: "female", label: "optionFemale" },
                                { value: "other", label: "optionOther" }
                            ]
                        },
                        {
                            id: "birthDate",
                            type: "date",
                            label: "labelDateOfBirth",
                            required: true
                        },
                        {
                            id: "address",
                            type: "text",
                            label: "labelAddress",
                            required: false
                        },
                        {
                            id: "phone",
                            type: "tel",
                            label: "labelPhone",
                            required: false
                        },
                        {
                            id: "email",
                            type: "email",
                            label: "labelEmail",
                            required: false
                        }
                    ]
                },
                {
                    id: "complaints",
                    title: "Aktueller Anlass / Beschwerden",
                    fields: [
                        {
                            id: "currentComplaints",
                            type: "textarea",
                            label: "labelCurrentComplaints",
                            required: true
                        }
                    ]
                },
                {
                    id: "symptoms",
                    title: "Allgemeine Symptome",
                    fields: [
                        {
                            id: "generalSymptoms",
                            type: "multiselect",
                            label: "Welche allgemeinen Symptome haben Sie?",
                            required: false,
                            options: [
                                { value: "fever", label: "Fieber" },
                                { value: "fatigue", label: "M√ºdigkeit" },
                                { value: "headache", label: "Kopfschmerzen" },
                                { value: "dizziness", label: "Schwindel" },
                                { value: "nausea", label: "√úbelkeit" },
                                { value: "pain", label: "Schmerzen" },
                                { value: "breathingIssues", label: "Atemprobleme" },
                                { value: "cough", label: "Husten" },
                                { value: "none", label: "Keine" }
                            ]
                        }
                    ]
                },
                {
                    id: "history",
                    title: "Vorerkrankungen & OPs",
                    fields: [
                        {
                            id: "pastIllnesses",
                            type: "textarea",
                            label: "labelPastIllnesses",
                            required: false
                        },
                        {
                            id: "surgeries",
                            type: "textarea",
                            label: "labelSurgeries",
                            required: false
                        },
                        {
                            id: "familyHistory",
                            type: "textarea",
                            label: "labelFamilyHistory",
                            required: false
                        }
                    ]
                },
                {
                    id: "medications",
                    title: "Medikamente & Allergien",
                    fields: [
                        {
                            id: "currentMedications",
                            type: "textarea",
                            label: "labelMedications",
                            required: false
                        },
                        {
                            id: "allergies",
                            type: "textarea",
                            label: "labelAllergies",
                            required: false
                        }
                    ]
                },
                {
                    id: "lifestyle",
                    title: "Lebensstil & Soziales",
                    fields: [
                        {
                            id: "smoking",
                            type: "select",
                            label: "labelSmoking",
                            required: false,
                            options: [
                                { value: "", label: "optionSelect" },
                                { value: "never", label: "optionNever" },
                                { value: "former", label: "optionFormer" },
                                { value: "current", label: "optionCurrent" }
                            ]
                        },
                        {
                            id: "alcohol",
                            type: "select",
                            label: "labelAlcohol",
                            required: false,
                            options: [
                                { value: "", label: "optionSelect" },
                                { value: "never", label: "optionAlcoholNever" },
                                { value: "occasional", label: "optionOccasional" },
                                { value: "regular", label: "optionRegular" }
                            ]
                        },
                        {
                            id: "exercise",
                            type: "textarea",
                            label: "labelExercise",
                            required: false
                        },
                        {
                            id: "additionalNotes",
                            type: "textarea",
                            label: "labelAdditionalNotes",
                            required: false
                        }
                    ]
                }
            ]
        };
        
        /* ========================================
           APPLICATION STATE
           ======================================== */
        
        const APP_STATE = {
            currentSectionIndex: 0,
            answers: {},
            privacyAccepted: false
        };
        
        /* ========================================
           HELPER FUNCTIONS
           ======================================== */
        
        function getTranslation(key) {
            const t = translations[currentLanguage] || translations.de;
            return t[key] || key;
        }
        
        function checkCondition(item) {
            if (!item.condition) {
                return true;
            }
            
            const { field, value, operator = '==' } = item.condition;
            const answer = APP_STATE.answers[field];
            
            if (answer === undefined || answer === null || answer === '') {
                return false;
            }
            
            if (Array.isArray(answer)) {
                if (operator === 'includes') {
                    return answer.includes(value);
                }
                return false;
            }
            
            switch (operator) {
                case '==': return answer == value;
                case '!=': return answer != value;
                case '>': return parseFloat(answer) > parseFloat(value);
                case '<': return parseFloat(answer) < parseFloat(value);
                case '>=': return parseFloat(answer) >= parseFloat(value);
                case '<=': return parseFloat(answer) <= parseFloat(value);
                default: return false;
            }
        }
        
        function updateProgress() {
            const total = APP_DATA.sections.length;
            const current = APP_STATE.currentSectionIndex + 1;
            const percentage = Math.round((current / total) * 100);
            
            const t = translations[currentLanguage] || translations.de;
            document.getElementById('progress-text').textContent = 
                t.stepText.replace('{current}', current).replace('{total}', total);
            document.getElementById('progress-percentage').textContent = percentage + '%';
            document.getElementById('progress-bar').style.width = percentage + '%';
        }
        
        function validateCurrentSection() {
            const section = APP_DATA.sections[APP_STATE.currentSectionIndex];
            
            for (const field of section.fields) {
                if (!checkCondition(field)) {
                    continue;
                }
                
                if (field.required) {
                    const answer = APP_STATE.answers[field.id];
                    if (!answer || (Array.isArray(answer) && answer.length === 0)) {
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        /* ========================================
           RENDERING FUNCTIONS
           ======================================== */
        
        function renderQuestion(field) {
            const t = translations[currentLanguage] || translations.de;
            const card = document.createElement('div');
            card.className = 'question-card';
            
            const label = document.createElement('label');
            label.className = 'question-label';
            label.textContent = getTranslation(field.label);
            if (field.required) {
                const required = document.createElement('span');
                required.className = 'question-required';
                required.textContent = '*';
                label.appendChild(required);
            }
            card.appendChild(label);
            
            let input;
            const currentAnswer = APP_STATE.answers[field.id];
            
            switch (field.type) {
                case 'text':
                case 'email':
                case 'tel':
                case 'number':
                    input = document.createElement('input');
                    input.type = field.type;
                    input.id = field.id;
                    input.value = currentAnswer || '';
                    input.addEventListener('input', (e) => {
                        APP_STATE.answers[field.id] = e.target.value;
                        updateNavigationButtons();
                    });
                    card.appendChild(input);
                    break;
                    
                case 'date':
                    input = document.createElement('input');
                    input.type = 'date';
                    input.id = field.id;
                    input.value = currentAnswer || '';
                    input.addEventListener('change', (e) => {
                        APP_STATE.answers[field.id] = e.target.value;
                        updateNavigationButtons();
                    });
                    card.appendChild(input);
                    break;
                    
                case 'textarea':
                    input = document.createElement('textarea');
                    input.id = field.id;
                    input.value = currentAnswer || '';
                    input.addEventListener('input', (e) => {
                        APP_STATE.answers[field.id] = e.target.value;
                        updateNavigationButtons();
                    });
                    card.appendChild(input);
                    break;
                    
                case 'select':
                    input = document.createElement('select');
                    input.id = field.id;
                    
                    field.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = getTranslation(opt.label);
                        if (currentAnswer === opt.value) {
                            option.selected = true;
                        }
                        input.appendChild(option);
                    });
                    
                    input.addEventListener('change', (e) => {
                        APP_STATE.answers[field.id] = e.target.value;
                        updateNavigationButtons();
                    });
                    card.appendChild(input);
                    break;
                    
                case 'multiselect':
                    const container = document.createElement('div');
                    container.className = 'options-container';
                    
                    const selectedValues = Array.isArray(currentAnswer) ? currentAnswer : [];
                    
                    field.options.forEach(opt => {
                        const item = document.createElement('div');
                        item.className = 'option-item';
                        if (selectedValues.includes(opt.value)) {
                            item.classList.add('selected');
                        }
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `${field.id}-${opt.value}`;
                        checkbox.value = opt.value;
                        checkbox.checked = selectedValues.includes(opt.value);
                        
                        const optLabel = document.createElement('label');
                        optLabel.textContent = opt.label;
                        optLabel.htmlFor = checkbox.id;
                        
                        item.appendChild(checkbox);
                        item.appendChild(optLabel);
                        
                        item.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'INPUT') {
                                checkbox.checked = !checkbox.checked;
                            }
                            item.classList.toggle('selected', checkbox.checked);
                            
                            const checkedValues = Array.from(container.querySelectorAll('input:checked'))
                                .map(cb => cb.value);
                            APP_STATE.answers[field.id] = checkedValues;
                            updateNavigationButtons();
                        });
                        
                        container.appendChild(item);
                    });
                    
                    card.appendChild(container);
                    break;
            }
            
            return card;
        }
        
        function renderCurrentSection() {
            const section = APP_DATA.sections[APP_STATE.currentSectionIndex];
            const t = translations[currentLanguage] || translations.de;
            
            document.getElementById('section-title').textContent = section.title;
            
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            section.fields.forEach(field => {
                if (checkCondition(field)) {
                    container.appendChild(renderQuestion(field));
                }
            });
            
            updateProgress();
            updateNavigationButtons();
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = APP_STATE.currentSectionIndex === 0;
            
            const isValid = validateCurrentSection();
            const isLastSection = APP_STATE.currentSectionIndex === APP_DATA.sections.length - 1;
            
            if (isLastSection) {
                nextBtn.textContent = 'Abschlie√üen';
            } else {
                nextBtn.textContent = getTranslation('btnNext');
            }
            
            nextBtn.disabled = !isValid;
        }
        
        /* ========================================
           NAVIGATION HANDLERS
           ======================================== */
        
        function goToPreviousSection() {
            if (APP_STATE.currentSectionIndex > 0) {
                APP_STATE.currentSectionIndex--;
                renderCurrentSection();
            }
        }
        
        function goToNextSection() {
            if (!validateCurrentSection()) {
                return;
            }
            
            if (APP_STATE.currentSectionIndex < APP_DATA.sections.length - 1) {
                APP_STATE.currentSectionIndex++;
                renderCurrentSection();
            } else {
                // Show export section
                document.querySelector('.question-section').classList.add('hidden');
                document.querySelector('.navigation-buttons').classList.add('hidden');
                document.getElementById('export-section').classList.remove('hidden');
                
                const t = translations[currentLanguage] || translations.de;
                document.querySelector('#export-section .export-title').textContent = t.completeTitle;
            }
        }
        
        /* ========================================
           EXPORT FUNCTIONS
           ======================================== */
        
        function showPasswordModal(action) {
            currentAction = action;
            const modal = document.getElementById('password-modal');
            modal.style.display = 'block';
            document.getElementById('encryption-password').value = '';
            document.getElementById('encryption-password').focus();
        }
        
        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            currentAction = null;
        }
        
        async function performSave(password) {
            try {
                const data = {
                    version: APP_DATA.version,
                    timestamp: new Date().toISOString(),
                    language: currentLanguage,
                    answers: APP_STATE.answers,
                    documents: DOCUMENT_STORAGE_GDPR.getAllDocuments()
                };
                
                const jsonData = JSON.stringify(data);
                const encryptedData = await encryptData(jsonData, password);
                
                const blob = new Blob([encryptedData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `anamnese_encrypted_${new Date().toISOString().split('T')[0]}.enc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(getTranslation('alertSaved'));
            } catch (error) {
                console.error('Save error:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }
        
        function exportJSON() {
            const data = {
                version: APP_DATA.version,
                timestamp: new Date().toISOString(),
                language: currentLanguage,
                answers: APP_STATE.answers,
                documents: DOCUMENT_STORAGE_GDPR.getAllDocuments()
            };
            
            const jsonData = JSON.stringify(data, null, 2);
            
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `anamnese_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(getTranslation('alertExported'));
        }
        
        /* ========================================
           EVENT LISTENERS
           ======================================== */
        
        document.addEventListener('DOMContentLoaded', function() {
            // Privacy screen
            const privacyCheckbox = document.getElementById('privacy-checkbox');
            const startBtn = document.getElementById('start-btn');
            
            privacyCheckbox.addEventListener('change', () => {
                startBtn.disabled = !privacyCheckbox.checked;
            });
            
            startBtn.addEventListener('click', () => {
                APP_STATE.privacyAccepted = true;
                document.getElementById('privacy-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                renderCurrentSection();
            });
            
            // Language change
            document.getElementById('language').addEventListener('change', changeLanguage);
            
            // Navigation
            document.getElementById('prev-btn').addEventListener('click', goToPreviousSection);
            document.getElementById('next-btn').addEventListener('click', goToNextSection);
            
            // Export buttons
            document.getElementById('export-encrypted-btn').addEventListener('click', () => {
                showPasswordModal('save');
            });
            
            document.getElementById('export-json-btn').addEventListener('click', exportJSON);
            
            document.getElementById('upload-documents-btn').addEventListener('click', async () => {
                const result = await showDocumentUploadDialogGDPR();
                if (result.success) {
                    alert(`Erfolgreich ${result.processedCount} Dokument(e) hochgeladen!`);
                } else {
                    alert(result.message || 'Fehler beim Hochladen');
                }
            });
            
            document.getElementById('view-documents-btn').addEventListener('click', showUploadedDocumentsGDPR);
            
            // Password modal
            const modal = document.getElementById('password-modal');
            document.querySelector('.modal-close').addEventListener('click', closePasswordModal);
            document.getElementById('modal-cancel').addEventListener('click', closePasswordModal);
            
            document.getElementById('modal-confirm').addEventListener('click', async () => {
                const password = document.getElementById('encryption-password').value;
                
                if (!password) {
                    alert(getTranslation('alertPassword'));
                    return;
                }
                
                closePasswordModal();
                
                if (currentAction === 'save') {
                    await performSave(password);
                }
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closePasswordModal();
                }
            });
            
            // Handle Enter key in password field
            document.getElementById('encryption-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('modal-confirm').click();
                }
            });
        });
    </script>
</body>
</html>
